<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReferenceFrame</title>

    <!-- Preload critical Pyodide assets for faster startup -->
    <!-- These start downloading immediately, before PyScript requests them -->
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.asm.wasm" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.asm.js" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/python_stdlib.zip" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide-lock.json" as="fetch" crossorigin="anonymous">

    <!-- PWA manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#277da1">

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.2/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.6.2/core.js"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- svg2pdf.js for vector SVG embedding (try jsdelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.3/dist/svg2pdf.umd.min.js"></script>

    <!-- Helper function to create PDF with vector SVG (called from Python) -->
    <script>
        // Cache jsPDF constructor at load time (before Pyodide might interfere)
        const _jsPDF = window.jspdf.jsPDF;
        console.log("Cached _jsPDF, test pdf.svg:", typeof (new _jsPDF()).svg);

        window.createPdfWithVectorSvg = async function(x, y, width, height) {
            console.log("createPdfWithVectorSvg called");

            const svg = document.querySelector("#matplotlib-canvas svg");
            if (!svg) {
                console.error("No SVG found");
                return null;
            }

            try {
                // Use cached constructor
                const pdf = new _jsPDF();
                console.log("pdf.svg exists:", typeof pdf.svg === 'function');

                if (typeof pdf.svg !== 'function') {
                    // Fallback: try window.svg2pdf.svg2pdf directly
                    if (window.svg2pdf && typeof window.svg2pdf.svg2pdf === 'function') {
                        console.log("Using window.svg2pdf.svg2pdf()");
                        await window.svg2pdf.svg2pdf(svg, pdf, { x, y, width, height });
                    } else {
                        console.error("No svg method available");
                        return null;
                    }
                } else {
                    console.log("Using pdf.svg()");
                    await pdf.svg(svg, { x, y, width, height });
                }

                console.log("Vector SVG added successfully");
                return pdf;
            } catch (e) {
                console.error("Error:", e);
                return null;
            }
        };
    </script>

    <!-- Instant settings restoration - runs before PyScript loads -->
    <script>
        // Restore form values immediately from localStorage (< 100ms)
        // This provides instant UI restoration while PyScript boots up in background
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const settingsJson = localStorage.getItem('frame_designer_settings');
                if (settingsJson) {
                    const settings = JSON.parse(settingsJson);

                    // Restore all form fields
                    const fields = [
                        'artwork-height', 'artwork-width', 'mat-width', 'frame-width',
                        'glazing-thickness', 'matboard-thickness', 'artwork-thickness',
                        'backing-thickness', 'rabbet-depth', 'frame-depth', 'blade-width'
                    ];

                    fields.forEach(fieldId => {
                        const element = document.getElementById(fieldId);
                        const settingKey = fieldId.replaceAll('-', '_');
                        if (element && settings[settingKey]) {
                            element.value = settings[settingKey];
                        }
                    });

                    console.log('‚ö° Settings restored instantly via vanilla JS');
                }

                // Restore unit toggle button state
                const savedUnit = localStorage.getItem('frame_designer_unit');
                if (savedUnit === 'mm') {
                    document.getElementById('unit-mm')?.classList.add('active');
                    document.getElementById('unit-inches')?.classList.remove('active');
                }
            } catch (e) {
                console.error('Error in instant restore:', e);
            }
        });
    </script>

    <style>
        /* CSS Variables - Design System */
        :root {
            /* Colors - Custom palette */
            --rf-primary-blue: #277da1;        /* cerulean */
            --rf-primary-blue-dark: #577590;   /* blue-slate */
            --rf-bg-dark: #0e1117;
            --rf-bg-section: #262730;
            --rf-bg-input: #1a1d24;
            --rf-text-light: #fafafa;
            --rf-text-muted: #b0b0b0;
            --rf-success-green: #90be6d;       /* willow-green */
            --rf-warning-orange: #f9c74f;      /* tuscan-sun */
            --rf-error-red: #f94144;           /* strawberry-red */

            /* Extended palette */
            --rf-atomic-tangerine: #f3722c;
            --rf-carrot-orange: #f8961e;
            --rf-coral-glow: #f9844a;
            --rf-seagrass: #43aa8b;
            --rf-dark-cyan: #4d908e;

            /* Spacing (4px grid) */
            --rf-space-2: 0.5rem;    /* 8px */
            --rf-space-3: 0.75rem;   /* 12px */
            --rf-space-4: 1rem;      /* 16px */
            --rf-space-5: 1.5rem;    /* 24px */
            --rf-space-6: 2rem;      /* 32px */

            /* Typography */
            --rf-font-size-sm: 0.875rem;   /* 14px */
            --rf-font-size-base: 1rem;     /* 16px - prevents iOS zoom */
            --rf-font-size-lg: 1.125rem;   /* 18px */
            --rf-font-size-xl: 1.25rem;    /* 20px */
            --rf-font-size-2xl: 1.5rem;    /* 24px */

            /* Accessibility */
            --rf-touch-target-min: 44px;   /* iOS HIG + WCAG */
            --rf-border-radius: 6px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: var(--rf-space-5);
            background: var(--rf-bg-dark);
            color: var(--rf-text-light);
            line-height: 1.6;
        }

        h1 {
            color: var(--rf-primary-blue);
            border-bottom: 2px solid var(--rf-primary-blue);
            padding-bottom: var(--rf-space-3);
            font-size: var(--rf-font-size-2xl);
            margin-top: 0;
        }

        h2 {
            font-size: var(--rf-font-size-xl);
            margin-top: 0;
        }

        .section {
            background: var(--rf-bg-section);
            padding: var(--rf-space-5);
            margin: var(--rf-space-5) 0;
            border-radius: var(--rf-border-radius);
            border-left: 4px solid var(--rf-primary-blue);
        }

        .form-group {
            margin: var(--rf-space-4) 0;
        }

        label {
            display: block;
            margin-bottom: var(--rf-space-2);
            color: var(--rf-text-light);
            font-weight: 500;
            font-size: var(--rf-font-size-base);
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            max-width: 300px;
            padding: var(--rf-space-3) var(--rf-space-4);
            background: var(--rf-bg-dark);
            border: 1px solid var(--rf-primary-blue);
            border-radius: 4px;
            color: var(--rf-text-light);
            font-size: var(--rf-font-size-base);
            min-height: var(--rf-touch-target-min);
        }

        input[type="radio"] {
            width: auto;
            min-height: auto;
        }

        button {
            background: var(--rf-primary-blue);
            color: white;
            border: none;
            padding: var(--rf-space-3) var(--rf-space-5);
            border-radius: var(--rf-border-radius);
            cursor: pointer;
            font-size: var(--rf-font-size-base);
            font-weight: bold;
            margin: var(--rf-space-3) var(--rf-space-2);
            min-height: var(--rf-touch-target-min);
            transition: background 0.2s ease;
        }

        button:hover {
            background: var(--rf-primary-blue-dark);
        }

        button:active {
            transform: scale(0.98);
        }

        #results {
            background: var(--rf-bg-input);
            padding: var(--rf-space-4);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: var(--rf-font-size-sm);
            line-height: 1.8;
        }

        .success {
            color: var(--rf-success-green);
            font-weight: bold;
        }

        .warning {
            color: var(--rf-warning-orange);
        }

        #canvas-container {
            background: white;
            padding: var(--rf-space-5);
            border-radius: var(--rf-border-radius);
            margin: var(--rf-space-5) 0;
        }

        #matplotlib-canvas svg {
            /* CSS override of inline SVG dimensions for responsive scaling */
            display: block;
            width: 100% !important;
            height: auto !important;
            max-width: 100%;
        }

        .loading {
            color: var(--rf-primary-blue);
            font-style: italic;
        }

        /* Logo - overlapping frames */
        .logo {
            display: inline-block;
            width: 28px;
            height: 28px;
            position: relative;
        }

        .logo::before,
        .logo::after {
            content: "";
            position: absolute;
            border: 2.5px solid;
            border-radius: 2px;
            box-sizing: border-box;
        }

        .logo::before {
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            border-color: var(--rf-success-green);
        }

        .logo::after {
            width: 20px;
            height: 20px;
            bottom: 0;
            right: 0;
            border-color: var(--rf-warning-orange);
        }

        /* App status indicator - corner swap loader (landscape frame) */
        .app-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 16px;
            position: relative;
        }

        .app-status.loading {
            display: grid;
        }

        .app-status.loading::before,
        .app-status.loading::after {
            content: "";
            grid-area: 1/1;
            border-top: 2px solid var(--rf-seagrass);
            border-left: 2px solid var(--rf-seagrass);
            width: 8px;
            height: 6px;
            animation: corner-swap-landscape 2s infinite;
            will-change: transform;
            backface-visibility: hidden;
        }

        .app-status.loading::after {
            --sx: -1;
            --sy: -1;
        }

        @keyframes corner-swap-landscape {
            0%,
            10%  { transform: scale(var(--sx, 1), var(--sy, 1)) translate(0, 0) rotate(0deg); }
            33%  { transform: scale(var(--sx, 1), var(--sy, 1)) translate(12px, -8px) rotate(0deg); }
            66%  { transform: scale(var(--sx, 1), var(--sy, 1)) translate(12px, -8px) rotate(180deg); }
            90%,
            100% { transform: scale(var(--sx, 1), var(--sy, 1)) translate(0, 0) rotate(180deg); }
        }

        .app-status.ready {
            animation: none;
            display: inline-block;
            color: var(--rf-success-green);
            font-size: 1.2rem;
            text-align: center;
            line-height: 18px;
        }

        .app-status.ready::before,
        .app-status.ready::after {
            content: none;
        }

        /* Compact Unit Toggle */
        .unit-toggle {
            display: inline-flex;
            font-size: inherit;
            align-items: baseline;
        }

        .unit-btn {
            padding: 0;
            border: none;
            background: transparent !important;
            color: #666;
            cursor: pointer;
            font-size: inherit;
            font-weight: 400;
        }

        .unit-btn:hover,
        .unit-btn:focus {
            background: transparent !important;
            color: #666;
            outline: none;
        }

        .unit-btn.active:hover,
        .unit-btn.active:focus {
            color: var(--rf-primary-blue);
        }

        .unit-toggle .pipe {
            color: #666;
            line-height: 1;
        }

        .unit-btn.active {
            color: var(--rf-primary-blue);
            font-weight: 700;
        }

        /* Paired dimension inputs (H √ó W on same line) */
        .dimension-pair {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dimension-pair input {
            flex: 1;
            min-width: 70px;  /* Ensure inputs are wide enough to show values */
        }

        .dimension-pair .separator {
            color: #888;
            font-weight: bold;
            flex-shrink: 0;
        }

        .dimension-pair .dim-label {
            color: #888;
            font-size: 12px;
            flex-shrink: 0;
            min-width: 14px;
        }

        /* Aspect ratio lock */
        .aspect-lock-btn {
            padding: 0 4px;
            border: none;
            background: transparent;
            cursor: pointer;
            flex-shrink: 0;
            transition: color 0.15s ease;
            -webkit-tap-highlight-color: transparent;  /* Remove mobile tap highlight */
            outline: none;
        }

        .aspect-lock-btn svg {
            width: 19px;
            height: 19px;
            fill: currentColor;
            vertical-align: middle;
        }

        .aspect-lock-btn.unlocked {
            color: var(--rf-success-green);
        }

        .aspect-lock-btn.locked {
            color: var(--rf-error-red);
        }

        .aspect-lock-btn:hover,
        .aspect-lock-btn:focus,
        .aspect-lock-btn:active {
            outline: none;
            background: transparent;
        }

        .aspect-ratio {
            color: #888;
            font-size: 12px;
            flex-shrink: 0;
            min-width: 30px;
        }

        .aspect-ratio.locked {
            color: var(--rf-primary-blue);
        }

        /* Orientation toggle */
        .orientation-btn {
            padding: 0;
            border: none;
            background: transparent;
            cursor: pointer;
            flex-shrink: 0;
            display: inline-grid;
            align-items: center;
            justify-items: start;
            margin-left: 6px;
            align-self: center;
        }

        .orientation-icon {
            grid-area: 1 / 1;
            border: 2px solid;
            border-radius: 1px;
            box-sizing: border-box;
        }

        .orientation-icon.landscape-outline {
            width: 24px;
            height: 14px;
            border-color: #444;
        }

        .orientation-icon.portrait-outline {
            width: 14px;
            height: 24px;
            border-color: #444;
        }

        .orientation-btn.landscape .landscape-outline {
            border-color: var(--rf-primary-blue);
            z-index: 1;
        }

        .orientation-btn.portrait .portrait-outline {
            border-color: var(--rf-primary-blue);
            z-index: 1;
        }

        .orientation-btn:hover,
        .orientation-btn:focus,
        .orientation-btn:active {
            outline: none;
            background: transparent;
        }

        /* Disabled input state */
        input:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Two-column grid for advanced options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 20px;
        }

        .options-grid .form-group {
            margin-bottom: 0;
        }

        @media (max-width: 500px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile-First Responsive Styles */

        /* Mobile devices (< 768px) */
        /* Size selector grid - stack on mobile */
        .size-selector-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            body {
                padding: var(--rf-space-4);
                max-width: 100%;
            }

            h1 {
                font-size: var(--rf-font-size-xl);
            }

            h2 {
                font-size: var(--rf-font-size-lg);
            }

            .section {
                padding: var(--rf-space-4);
                margin: var(--rf-space-4) 0;
            }

            input[type="number"],
            input[type="text"],
            select {
                max-width: 100%;
                font-size: var(--rf-font-size-base); /* Prevents iOS zoom */
            }

            /* Compact dimension inputs on mobile - flexible but compact */
            .dimension-pair {
                flex-wrap: nowrap;
                gap: 6px;  /* Balanced gap */
            }

            .dimension-pair input[type="number"] {
                width: 5ch;
                min-width: 5ch;
                flex: 1 1 5ch;
                max-width: 8ch;
                padding: 6px 4px;  /* Comfortable padding */
                -moz-appearance: textfield;
            }

            /* Hide number input spinners to save space */
            .dimension-pair input[type="number"]::-webkit-inner-spin-button,
            .dimension-pair input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .dimension-pair .aspect-ratio,
            .dimension-pair .dim-label {
                min-width: auto;
            }

            .dimension-pair .separator {
                margin: 0 2px;
            }

            button {
                width: 100%;
                margin: var(--rf-space-2) 0;
            }

            /* Except buttons inside dimension-pair - keep them compact */
            .dimension-pair button {
                width: auto;
                margin: 0;
                flex-shrink: 0;
            }

            /* Stack size selectors vertically on mobile */
            .size-selector-grid {
                grid-template-columns: 1fr;
            }

            /* Stack unit selection vertically */
            .section [style*="display: flex"] {
                flex-direction: column !important;
                align-items: flex-start !important;
            }

            /* Make custom sizes buttons stack */
            #saved-sizes-container [style*="display: flex"] {
                flex-direction: column !important;
            }

            #saved-sizes-container button {
                width: 100% !important;
            }

            #canvas-container {
                padding: var(--rf-space-3);
            }

            /* Reduce results font size on mobile */
            #results {
                font-size: 0.75rem;
            }
        }

        /* Tablet devices (640px - 1024px) */
        @media (min-width: 640px) and (max-width: 1024px) {
            body {
                padding: var(--rf-space-5);
            }

            .section {
                padding: var(--rf-space-5);
            }
        }

        /* PWA Standalone Mode (Notched devices) */
        @media (display-mode: standalone) {
            body {
                padding-top: max(var(--rf-space-5), env(safe-area-inset-top));
                padding-bottom: max(var(--rf-space-5), env(safe-area-inset-bottom));
                padding-left: max(var(--rf-space-4), env(safe-area-inset-left));
                padding-right: max(var(--rf-space-4), env(safe-area-inset-right));
            }
        }

        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            button {
                border: 1px solid rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body>
    <h1 style="display: flex; align-items: center; gap: 12px;">
        <span class="logo"></span>
        ReferenceFrame
        <span id="app-status" class="app-status loading" title="Loading application..."></span>
    </h1>

    <div class="section">
        <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <span>üìê Frame Calculator</span>
            <!-- Compact Unit Toggle -->
            <div class="unit-toggle">
                <button type="button" id="unit-inches" class="unit-btn active">in</button><span style="color: #666;">|</span><button type="button" id="unit-mm" class="unit-btn">mm</button>
            </div>
        </h2>

        <div class="form-group">
            <label>Artwork <span id="label-artwork-unit">(inches)</span>:</label>
            <div class="dimension-pair">
                <span class="dim-label">H</span>
                <input type="number" id="artwork-height" value="12.5" step="0.25" min="1">
                <span class="separator">√ó</span>
                <span class="dim-label">W</span>
                <input type="number" id="artwork-width" value="18.75" step="0.25" min="1">
                <button type="button" id="orientation-toggle" class="orientation-btn landscape" title="Toggle portrait/landscape">
                    <span class="orientation-icon landscape-outline"></span>
                    <span class="orientation-icon portrait-outline"></span>
                </button>
                <span id="aspect-ratio" class="aspect-ratio">3:2</span>
                <button type="button" id="aspect-lock" class="aspect-lock-btn unlocked" title="Lock aspect ratio"><svg viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg></button>
            </div>
        </div>
        <div class="options-grid" style="margin-bottom: 15px;">
            <div class="form-group">
                <label for="mat-width">
                    <input type="checkbox" id="include-mat" checked style="width: auto; margin-right: 6px; vertical-align: middle;">
                    Mat Width <span id="label-mat-unit">(inches)</span>
                </label>
                <input type="number" id="mat-width" value="2.0" step="0.125" min="0.125">
            </div>
            <div class="form-group">
                <label for="frame-width">Frame Width <span id="label-frame-unit">(inches)</span></label>
                <input type="number" id="frame-width" value="0.75" step="0.125" min="0.5">
            </div>
        </div>

        <!-- Advanced Material Thickness Options -->
        <details style="margin-top: 15px; padding: 10px; background: #1a1d24; border-radius: 4px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">
                ‚öôÔ∏è Advanced Options
            </summary>
            <div class="options-grid" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="glazing-thickness">Glazing <span id="label-glazing-unit">(in)</span></label>
                    <input type="number" id="glazing-thickness" value="0.093" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="matboard-thickness">Matboard <span id="label-matboard-unit">(in)</span></label>
                    <input type="number" id="matboard-thickness" value="0.055" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="artwork-thickness">Artwork <span id="label-artwork-thickness-unit">(in)</span></label>
                    <input type="number" id="artwork-thickness" value="0.008" step="0.001" min="0">
                </div>
                <div class="form-group">
                    <label for="backing-thickness">Backing <span id="label-backing-unit">(in)</span></label>
                    <input type="number" id="backing-thickness" value="0.125" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="rabbet-depth">Rabbet Depth <span id="label-rabbet-unit">(in)</span></label>
                    <input type="number" id="rabbet-depth" value="0.375" step="0.125" min="0">
                </div>
                <div class="form-group">
                    <label for="frame-depth">Frame Depth <span id="label-frame-depth-unit">(in)</span></label>
                    <input type="number" id="frame-depth" value="0.75" step="0.125" min="0.25">
                </div>
                <div class="form-group">
                    <label for="blade-width">Blade Width <span id="label-blade-unit">(in)</span></label>
                    <input type="number" id="blade-width" value="0.125" step="0.03125" min="0">
                </div>
            </div>
        </details>

        <!-- Saved Configurations Section -->
        <details style="margin-top: 15px; padding: 10px; background: #1a1d24; border-radius: 4px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">
                üíæ Saved Configurations
            </summary>
            <div style="margin-top: 15px;">
                <div class="form-group">
                    <label for="config-name">Configuration Name:</label>
                    <input type="text" id="config-name" placeholder="e.g., Standard Print, Large Canvas">
                </div>
                <button id="save-config" style="background-color: #2a7d2e;">Save Current Configuration</button>
                <div id="saved-configs-list" style="margin-top: 15px;">
                    <!-- Saved configurations will be rendered here -->
                </div>
            </div>
        </details>

        <button id="reset-settings" style="background-color: #666;">Reset to Defaults</button>
        <!-- Manual trigger buttons hidden since auto-update handles this -->
        <button id="calculate" style="display: none;">Calculate Frame</button>
        <button id="draw-viz" style="display: none;">Draw Visualization</button>

        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <div class="section">
        <h2>üìê Artwork Size Selector</h2>
        <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 15px;">
            Choose from standard photo sizes or your saved custom sizes.
        </p>

        <div class="size-selector-grid" style="margin-bottom: 20px;">
            <!-- Standard Sizes -->
            <div style="background: #1a1d24; padding: 15px; border-radius: 4px;">
                <label for="standard-sizes-select" style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">
                    üìê Standard Sizes
                </label>
                <select id="standard-sizes-select" style="width: 100%; padding: 8px 12px; background: #0e1117; border: 1px solid #3b9cff; border-radius: 4px; color: #fafafa; font-size: 16px; min-height: 44px; margin-bottom: 10px;">
                    <option value="">-- Select a size --</option>
                </select>
                <button id="apply-standard-size" style="width: 100%; padding: 10px 20px;">Apply Size</button>
            </div>

            <!-- Custom Sizes -->
            <div style="background: #1a1d24; padding: 15px; border-radius: 4px;">
                <label for="saved-sizes-select" style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">
                    üìè Custom Sizes
                </label>
                <select id="saved-sizes-select" style="width: 100%; padding: 8px 12px; background: #0e1117; border: 1px solid #3b9cff; border-radius: 4px; color: #fafafa; font-size: 16px; min-height: 44px; margin-bottom: 10px;">
                    <option value="">-- No saved sizes --</option>
                </select>
                <div style="display: flex; gap: 8px;">
                    <button id="apply-saved-size" style="flex: 1; padding: 10px; white-space: nowrap;">Apply</button>
                    <button id="delete-saved-size" style="padding: 10px 16px; background: #dc3545; white-space: nowrap;">Delete</button>
                </div>
            </div>
        </div>

        <!-- Add Custom Size Form -->
        <details style="background: #1a1d24; padding: 15px; border-radius: 4px; margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">
                ‚ûï Add New Custom Size
            </summary>
            <div style="margin-top: 15px;">
                <div class="form-group">
                    <label for="custom-size-name">Size Name:</label>
                    <input type="text" id="custom-size-name" placeholder="e.g., Canvas 18x24" style="width: 100%; max-width: 300px;">
                </div>
                <div class="form-group">
                    <label for="custom-size-height">Height <span id="label-custom-height-unit">(inches)</span>:</label>
                    <input type="number" id="custom-size-height" value="18.0" step="0.25" min="1" style="width: 150px;">
                </div>
                <div class="form-group">
                    <label for="custom-size-width">Width <span id="label-custom-width-unit">(inches)</span>:</label>
                    <input type="number" id="custom-size-width" value="24.0" step="0.25" min="1" style="width: 150px;">
                </div>
                <button id="add-custom-size" style="margin-top: 10px;">üíæ Save Custom Size</button>
                <div id="add-size-message" style="margin-top: 10px;"></div>
            </div>
        </details>
    </div>

    <div class="section">
        <h2>üé® Visualization</h2>
        <div id="canvas-container">
            <div id="matplotlib-canvas"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìÑ Export</h2>
        <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 15px;">
            Download a printable summary with all dimensions and specifications.
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="export-text">Download Text Summary</button>
            <button id="export-pdf">Download PDF with Diagram</button>
        </div>
        <div id="export-status" style="margin-top: 10px;"></div>
    </div>

    <!-- PyScript Configuration -->
    <py-config type="json">
        {
            "packages": ["matplotlib"],
            "files": {
                "./src/frame.py": "./frame.py",
                "./src/conversions.py": "./conversions.py",
                "./src/defaults.py": "./defaults.py",
                "./src/ui_helpers.py": "./ui_helpers.py",
                "./src/aspect_ratio.py": "./aspect_ratio.py"
            }
        }
    </py-config>

    <!-- Main PyScript Code -->
    <py-script>
        from pyscript import document, when
        from js import localStorage, console
        import json

        # Import our existing code
        from frame import FrameDesign, FrameSize
        from conversions import format_value, inches_to_mm, mm_to_inches
        from ui_helpers import input_to_inches, round_to_step, FIELD_IDS
        from aspect_ratio import (
            get_aspect_ratio_display,
            get_aspect_ratio_display_from_ratio,
            AspectLockState,
        )
        from defaults import (
            DEFAULT_ARTWORK_HEIGHT,
            DEFAULT_ARTWORK_WIDTH,
            DEFAULT_INCLUDE_MAT,
            DEFAULT_MAT_WIDTH,
            DEFAULT_FRAME_MATERIAL_WIDTH,
            DEFAULT_FRAME_THICKNESS,
            DEFAULT_RABBET_DEPTH,
            DEFAULT_GLAZING_THICKNESS,
            DEFAULT_MATBOARD_THICKNESS,
            DEFAULT_ARTWORK_THICKNESS,
            DEFAULT_BACKING_THICKNESS,
            DEFAULT_BLADE_WIDTH,
        )

        # Application state
        app_state = {
            "current_unit": "inches",  # Current display unit
            "custom_sizes": [],  # List of FrameSize objects
        }

        # Load unit preference from localStorage
        try:
            saved_unit = localStorage.getItem("frame_designer_unit")
            if saved_unit and saved_unit in ["inches", "mm"]:
                app_state["current_unit"] = saved_unit
                # Update toggle button active state
                if saved_unit == "mm":
                    document.getElementById("unit-mm").classList.add("active")
                    document.getElementById("unit-inches").classList.remove("active")
                    # Update labels
                    document.getElementById("label-artwork-unit").textContent = "(mm)"
                    document.getElementById("label-mat-unit").textContent = "(mm)"
                    document.getElementById("label-frame-unit").textContent = "(mm)"
                console.log(f"Restored unit preference: {saved_unit}")
        except Exception as e:
            console.log(f"Could not load unit preference: {e}")

        # Test matplotlib loading
        try:
            import matplotlib
            import matplotlib.font_manager as fm
            # Use 'none' fonttype - required for svg2pdf.js (fonttype 42 causes missing chars)
            # Trade-off: text rendered by browser/PDF viewer, not matplotlib's bundled font
            matplotlib.rcParams['svg.fonttype'] = 'none'
            # DejaVu Sans is included in Pyodide, so matplotlib uses it for bbox calculations.
            # Put it first so PDF rendering uses the same font as matplotlib's measurements.
            # This ensures bounding boxes around text fit properly.
            matplotlib.rcParams['font.family'] = 'sans-serif'
            matplotlib.rcParams['font.sans-serif'] = ['DejaVu Sans', 'Verdana', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
            matplotlib.rcParams['font.size'] = 10
            # Debug: show which font was actually selected
            try:
                prop = fm.FontProperties()
                prop.set_family('sans-serif')
                selected_font = fm.findfont(prop)
                console.log(f"matplotlib: font selected = {selected_font}")
            except Exception as e:
                console.log(f"matplotlib: could not determine font: {e}")
            console.log("matplotlib: configured with DejaVu Sans priority (matches Pyodide metrics)")
            console.log("‚úÖ matplotlib loaded successfully")
        except Exception as e:
            console.log(f'‚è≥ matplotlib loading (may take 30s): {e}')

        # ===== Helper Functions (must be defined before custom sizes) =====

        def get_current_unit():
            """Get the currently selected unit from toggle buttons."""
            if "active" in document.getElementById("unit-inches").classList:
                return "inches"
            else:
                return "mm"

        # ===== Aspect Ratio Lock =====
        # Use AspectLockState class from aspect_ratio module
        aspect_lock = AspectLockState()

        # Compatibility shim for existing code that uses dict-style access
        aspect_lock_state = {
            "locked": False,
            "ratio": None
        }

        def update_aspect_ratio_display():
            """Update the displayed aspect ratio."""
            try:
                # If locked, always show the locked ratio
                if aspect_lock_state["locked"] and aspect_lock_state["ratio"]:
                    ratio_display = get_aspect_ratio_display_from_ratio(aspect_lock_state["ratio"])
                    console.log(f"Locked ratio display: {ratio_display} (ratio={aspect_lock_state['ratio']:.3f})")
                else:
                    # Show current ratio from field values
                    height_val = document.getElementById("artwork-height").value
                    width_val = document.getElementById("artwork-width").value
                    if not height_val or not width_val:
                        ratio_display = "‚Äî"
                    else:
                        height = float(height_val)
                        width = float(width_val)
                        console.log(f"Ratio calc: h={height}, w={width}")
                        ratio_display = get_aspect_ratio_display(height, width)
                        console.log(f"Ratio display: {ratio_display}")
            except (ValueError, TypeError) as e:
                console.log(f"Error in ratio display: {e}")
                ratio_display = "‚Äî"

            ratio_elem = document.getElementById("aspect-ratio")
            ratio_elem.textContent = ratio_display
            if aspect_lock_state["locked"]:
                ratio_elem.classList.add("locked")
            else:
                ratio_elem.classList.remove("locked")

        # input_to_inches and round_to_step are now imported from ui_helpers

        # ===== Standard Sizes =====

        # Common photo and artwork sizes (Height √ó Width convention)
        # "4√ó6" means height=4", width=6"
        # FrameSize stores (name, height, width)
        STANDARD_SIZES = [
            FrameSize("4√ó6", 4.0, 6.0),      # 4" tall √ó 6" wide
            FrameSize("5√ó7", 5.0, 7.0),      # 5" tall √ó 7" wide
            FrameSize("8√ó10", 8.0, 10.0),    # 8" tall √ó 10" wide
            FrameSize("11√ó14", 11.0, 14.0),  # 11" tall √ó 14" wide
            FrameSize("12√ó18", 12.0, 18.0),  # 12" tall √ó 18" wide
            FrameSize("16√ó20", 16.0, 20.0),  # 16" tall √ó 20" wide
            FrameSize("18√ó24", 18.0, 24.0),  # 18" tall √ó 24" wide
            FrameSize("20√ó30", 20.0, 30.0),  # 20" tall √ó 30" wide
        ]

        def render_standard_sizes():
            """Render standard size dropdown options."""
            select_elem = document.getElementById("standard-sizes-select")
            if not select_elem:
                return

            # Clear existing options except the first placeholder
            select_elem.innerHTML = '<option value="">-- Select a size --</option>'

            current_unit = get_current_unit()

            for idx, size in enumerate(STANDARD_SIZES):
                option = document.createElement("option")
                option.value = str(idx)

                # Format dimensions in current unit
                if current_unit == "inches":
                    # For standard sizes (whole numbers), don't show decimal equivalent
                    # Use use_tape_conversion=False to get simple whole number format
                    if size.height == int(size.height) and size.width == int(size.width):
                        height_str = f'{int(size.height)}"'
                        width_str = f'{int(size.width)}"'
                    else:
                        height_str = format_value(size.height, "inches", 2)
                        width_str = format_value(size.width, "inches", 2)
                    option.textContent = f"{size.name} ({height_str} √ó {width_str})"
                else:
                    height_mm = inches_to_mm(size.height)
                    width_mm = inches_to_mm(size.width)
                    option.textContent = f"{size.name} ({height_mm:.0f} √ó {width_mm:.0f}mm)"

                select_elem.appendChild(option)

        def apply_standard_size(height, width):
            """Apply a standard size to the form inputs."""
            current_unit = get_current_unit()

            if current_unit == "mm":
                # Convert to mm for display
                document.getElementById("artwork-height").value = str(inches_to_mm(height))
                document.getElementById("artwork-width").value = str(inches_to_mm(width))
            else:
                document.getElementById("artwork-height").value = str(height)
                document.getElementById("artwork-width").value = str(width)

            # Auto-render visualization
            render_visualization()

        # Event handler for apply standard size button
        @when("click", "#apply-standard-size")
        def handle_apply_standard_size(event):
            """Handle apply standard size button click."""
            select_elem = document.getElementById("standard-sizes-select")
            selected_value = select_elem.value

            if selected_value and selected_value != "":
                idx = int(selected_value)
                size = STANDARD_SIZES[idx]
                apply_standard_size(size.height, size.width)

        # ===== Custom Sizes Management =====

        def load_custom_sizes():
            """Load custom sizes from localStorage."""
            try:
                sizes_data = localStorage.getItem("frame_designer_custom_sizes")
                if sizes_data and sizes_data != "null":
                    sizes_list = json.loads(sizes_data)
                    app_state["custom_sizes"] = [
                        FrameSize(name=s["name"], height=s["height"], width=s["width"])
                        for s in sizes_list
                    ]
                    console.log(f"Loaded {len(app_state['custom_sizes'])} custom sizes")
                else:
                    app_state["custom_sizes"] = []
            except Exception as e:
                console.log(f"Error loading custom sizes: {e}")
                app_state["custom_sizes"] = []

        def save_custom_sizes():
            """Save custom sizes to localStorage."""
            try:
                sizes_data = [
                    {"name": s.name, "height": s.height, "width": s.width}
                    for s in app_state["custom_sizes"]
                ]
                localStorage.setItem("frame_designer_custom_sizes", json.dumps(sizes_data))
                console.log(f"Saved {len(sizes_data)} custom sizes")
            except Exception as e:
                console.log(f"Error saving custom sizes: {e}")

        def render_custom_sizes():
            """Render the dropdown of custom sizes."""
            select_elem = document.getElementById("saved-sizes-select")

            # Check if element exists (DOM might not be ready yet)
            if not select_elem:
                console.log("Custom sizes dropdown not ready yet, skipping render")
                return

            # Clear existing options
            select_elem.innerHTML = ""

            if len(app_state["custom_sizes"]) == 0:
                # Show "no sizes" option
                option = document.createElement("option")
                option.value = ""
                option.textContent = "-- No saved sizes yet --"
                select_elem.appendChild(option)
            else:
                # Add placeholder option
                placeholder = document.createElement("option")
                placeholder.value = ""
                placeholder.textContent = "-- Select a size --"
                select_elem.appendChild(placeholder)

                # Add each saved size as an option
                current_unit = get_current_unit()
                for idx, size in enumerate(app_state["custom_sizes"]):
                    # Format dimensions in current unit
                    height_display = format_value(size.height, current_unit)
                    width_display = format_value(size.width, current_unit)

                    option = document.createElement("option")
                    option.value = str(idx)
                    option.textContent = f"{size.name} ({height_display} √ó {width_display})"
                    select_elem.appendChild(option)

        def apply_custom_size(index):
            """Apply a saved size to the form inputs."""
            try:
                if 0 <= index < len(app_state["custom_sizes"]):
                    size = app_state["custom_sizes"][index]
                    current_unit = get_current_unit()

                    # Convert from inches (storage format) to current display unit
                    if current_unit == "mm":
                        height_display = inches_to_mm(size.height)
                        width_display = inches_to_mm(size.width)
                    else:
                        height_display = size.height
                        width_display = size.width

                    # Update form inputs
                    document.getElementById("artwork-height").value = str(round(height_display, 2))
                    document.getElementById("artwork-width").value = str(round(width_display, 2))

                    console.log(f"Applied custom size: {size.name}")

                    # Automatically render visualization with new dimensions
                    render_visualization()
            except Exception as e:
                console.log(f"Error applying custom size: {e}")
                results_div = document.getElementById("results")
                results_div.innerHTML = f'<span class="warning">‚ùå Error: {e}</span>'

        def delete_custom_size(index):
            """Delete a saved size."""
            try:
                if 0 <= index < len(app_state["custom_sizes"]):
                    deleted_size = app_state["custom_sizes"][index]
                    app_state["custom_sizes"].pop(index)
                    save_custom_sizes()
                    render_custom_sizes()
                    console.log(f"Deleted custom size: {deleted_size.name}")

                    # Show success message
                    msg_div = document.getElementById("add-size-message")
                    msg_div.innerHTML = f'<div class="success">‚úÖ Deleted: {deleted_size.name}</div>'
                    # Clear message after 3 seconds
                    import asyncio
                    async def clear_message():
                        await asyncio.sleep(3)
                        msg_div.innerHTML = ""
                    asyncio.create_task(clear_message())
            except Exception as e:
                console.log(f"Error deleting custom size: {e}")

        # Load custom sizes on startup
        load_custom_sizes()

        # Render with retry to ensure DOM is ready
        import asyncio
        async def init_sizes():
            """Initialize standard and custom sizes display with retry for DOM readiness."""
            for attempt in range(5):
                custom_select = document.getElementById("saved-sizes-select")
                standard_select = document.getElementById("standard-sizes-select")
                if custom_select and standard_select:
                    render_standard_sizes()
                    render_custom_sizes()
                    console.log("Standard and custom sizes rendered successfully")
                    break
                else:
                    console.log(f"DOM not ready (attempt {attempt + 1}), waiting...")
                    await asyncio.sleep(0.2)

        asyncio.create_task(init_sizes())

        # Event handler: Apply saved size button
        @when("click", "#apply-saved-size")
        def handle_apply_saved_size(event):
            """Apply the selected saved size to the form."""
            select_elem = document.getElementById("saved-sizes-select")
            selected_value = select_elem.value

            if selected_value and selected_value != "":
                idx = int(selected_value)
                apply_custom_size(idx)
            else:
                results_div = document.getElementById("results")
                results_div.innerHTML = '<div class="warning">‚ö†Ô∏è Please select a size first</div>'

        # Event handler: Delete saved size button
        @when("click", "#delete-saved-size")
        def handle_delete_saved_size(event):
            """Delete the selected saved size."""
            select_elem = document.getElementById("saved-sizes-select")
            selected_value = select_elem.value

            if selected_value and selected_value != "":
                idx = int(selected_value)
                delete_custom_size(idx)
                # Reset dropdown selection after delete
                select_elem.value = ""
            else:
                msg_div = document.getElementById("add-size-message")
                msg_div.innerHTML = '<div class="warning">‚ö†Ô∏è Please select a size first</div>'

        # ===== End Custom Sizes Management =====

        # Event handler: Unit toggle button clicks
        def switch_unit(new_unit):
            """Handle unit toggle - convert all form values."""
            old_unit = app_state["current_unit"]

            if old_unit == new_unit:
                return  # No change

            # Update button active states
            inches_btn = document.getElementById("unit-inches")
            mm_btn = document.getElementById("unit-mm")
            if new_unit == "mm":
                inches_btn.classList.remove("active")
                mm_btn.classList.add("active")
            else:
                mm_btn.classList.remove("active")
                inches_btn.classList.add("active")

            # Get all input fields (main and advanced)
            height_input = document.getElementById("artwork-height")
            width_input = document.getElementById("artwork-width")
            mat_input = document.getElementById("mat-width")
            frame_input = document.getElementById("frame-width")
            glazing_input = document.getElementById("glazing-thickness")
            matboard_input = document.getElementById("matboard-thickness")
            artwork_t_input = document.getElementById("artwork-thickness")
            backing_input = document.getElementById("backing-thickness")
            rabbet_input = document.getElementById("rabbet-depth")

            # Convert values
            if new_unit == "mm":
                # Convert inches ‚Üí mm (main fields)
                height_input.value = str(round(inches_to_mm(float(height_input.value)), 1))
                width_input.value = str(round(inches_to_mm(float(width_input.value)), 1))
                mat_input.value = str(round(inches_to_mm(float(mat_input.value)), 1))
                frame_input.value = str(round(inches_to_mm(float(frame_input.value)), 1))

                # Convert advanced fields
                glazing_input.value = str(round(inches_to_mm(float(glazing_input.value)), 2))
                matboard_input.value = str(round(inches_to_mm(float(matboard_input.value)), 2))
                artwork_t_input.value = str(round(inches_to_mm(float(artwork_t_input.value)), 2))
                backing_input.value = str(round(inches_to_mm(float(backing_input.value)), 2))
                rabbet_input.value = str(round(inches_to_mm(float(rabbet_input.value)), 2))

                # Update step sizes for mm
                height_input.step = "1"
                width_input.step = "1"
                mat_input.step = "1"
                frame_input.step = "1"
                glazing_input.step = "0.1"
                matboard_input.step = "0.1"
                artwork_t_input.step = "0.1"
                backing_input.step = "0.1"
                rabbet_input.step = "1"

                # Update labels
                document.getElementById("label-artwork-unit").textContent = "(mm)"
                document.getElementById("label-mat-unit").textContent = "(mm)"
                document.getElementById("label-frame-unit").textContent = "(mm)"
                document.getElementById("label-glazing-unit").textContent = "(mm)"
                document.getElementById("label-matboard-unit").textContent = "(mm)"
                document.getElementById("label-artwork-thickness-unit").textContent = "(mm)"
                document.getElementById("label-backing-unit").textContent = "(mm)"
                document.getElementById("label-rabbet-unit").textContent = "(mm)"
                document.getElementById("label-frame-depth-unit").textContent = "(mm)"
                document.getElementById("label-blade-unit").textContent = "(mm)"
            else:
                # Convert mm ‚Üí inches (main fields) - round to step to avoid drift
                height_input.value = str(round_to_step(mm_to_inches(float(height_input.value)), 0.25))
                width_input.value = str(round_to_step(mm_to_inches(float(width_input.value)), 0.25))
                mat_input.value = str(round_to_step(mm_to_inches(float(mat_input.value)), 0.125))
                frame_input.value = str(round_to_step(mm_to_inches(float(frame_input.value)), 0.125))

                # Convert advanced fields
                glazing_input.value = str(round_to_step(mm_to_inches(float(glazing_input.value)), 0.01))
                matboard_input.value = str(round_to_step(mm_to_inches(float(matboard_input.value)), 0.01))
                artwork_t_input.value = str(round_to_step(mm_to_inches(float(artwork_t_input.value)), 0.01))
                backing_input.value = str(round_to_step(mm_to_inches(float(backing_input.value)), 0.01))
                rabbet_input.value = str(round_to_step(mm_to_inches(float(rabbet_input.value)), 0.125))

                # Update step sizes for inches
                height_input.step = "0.25"
                width_input.step = "0.25"
                mat_input.step = "0.125"
                frame_input.step = "0.125"
                glazing_input.step = "0.01"
                matboard_input.step = "0.01"
                artwork_t_input.step = "0.01"
                backing_input.step = "0.01"
                rabbet_input.step = "0.125"

                # Update labels
                document.getElementById("label-artwork-unit").textContent = "(inches)"
                document.getElementById("label-mat-unit").textContent = "(inches)"
                document.getElementById("label-frame-unit").textContent = "(inches)"
                document.getElementById("label-glazing-unit").textContent = "(in)"
                document.getElementById("label-matboard-unit").textContent = "(in)"
                document.getElementById("label-artwork-thickness-unit").textContent = "(in)"
                document.getElementById("label-backing-unit").textContent = "(in)"
                document.getElementById("label-rabbet-unit").textContent = "(in)"
                document.getElementById("label-frame-depth-unit").textContent = "(in)"
                document.getElementById("label-blade-unit").textContent = "(in)"

            # Update app state
            app_state["current_unit"] = new_unit

            # Save preference to localStorage
            localStorage.setItem("frame_designer_unit", new_unit)

            console.log(f"Unit changed from {old_unit} to {new_unit}")

            # Also update custom size form labels
            if new_unit == "mm":
                document.getElementById("label-custom-height-unit").textContent = "(millimeters)"
                document.getElementById("label-custom-width-unit").textContent = "(millimeters)"
                document.getElementById("custom-size-height").step = "1"
                document.getElementById("custom-size-width").step = "1"
            else:
                document.getElementById("label-custom-height-unit").textContent = "(inches)"
                document.getElementById("label-custom-width-unit").textContent = "(inches)"
                document.getElementById("custom-size-height").step = "0.25"
                document.getElementById("custom-size-width").step = "0.25"

            # Re-render standard and custom sizes to show in new unit
            render_standard_sizes()
            render_custom_sizes()

        @when("click", "#unit-inches")
        def handle_unit_inches(event):
            switch_unit("inches")

        @when("click", "#unit-mm")
        def handle_unit_mm(event):
            switch_unit("mm")

        # ===== Aspect Ratio Event Handlers =====

        # SVG icons for lock button (Material Design icons)
        # Unlocked: open shackle (lock_open)
        LOCK_ICON_UNLOCKED = '<svg viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg>'
        # Locked: closed shackle (lock)
        LOCK_ICON_LOCKED = '<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>'

        @when("click", "#aspect-lock")
        def handle_aspect_lock(event):
            """Toggle aspect ratio lock."""
            lock_btn = document.getElementById("aspect-lock")
            if aspect_lock_state["locked"]:
                # Unlock
                aspect_lock_state["locked"] = False
                aspect_lock_state["ratio"] = None
                lock_btn.innerHTML = LOCK_ICON_UNLOCKED
                lock_btn.className = "aspect-lock-btn unlocked"
                lock_btn.title = "Lock aspect ratio"
            else:
                # Lock current ratio
                height = float(document.getElementById("artwork-height").value)
                width = float(document.getElementById("artwork-width").value)
                if width > 0:
                    aspect_lock_state["locked"] = True
                    aspect_lock_state["ratio"] = height / width
                    lock_btn.innerHTML = LOCK_ICON_LOCKED
                    lock_btn.className = "aspect-lock-btn locked"
                    lock_btn.title = "Unlock aspect ratio"
            lock_btn.blur()  # Remove focus to clear highlight on mobile
            update_aspect_ratio_display()

        @when("input", "#artwork-height")
        def handle_height_change(event):
            """Handle height input change - update width if locked."""
            update_aspect_ratio_display()
            # Only update orientation if NOT locked (locked orientation is user-controlled via toggle button)
            if not aspect_lock_state["locked"]:
                update_orientation_icon()
            if aspect_lock_state["locked"] and aspect_lock_state["ratio"]:
                height_val = document.getElementById("artwork-height").value
                console.log(f"Height changed: '{height_val}', type: {type(height_val)}, bool: {bool(height_val)}")
                if not height_val or not str(height_val).strip():
                    # If height is cleared, clear width too
                    console.log("Height cleared, clearing width")
                    document.getElementById("artwork-width").value = ""
                else:
                    try:
                        height = float(height_val)
                        console.log(f"Parsed height: {height}, ratio: {aspect_lock_state['ratio']}")
                        if height > 0:  # Only update for positive values
                            new_width = height / aspect_lock_state["ratio"]
                            # Round to step
                            step = float(document.getElementById("artwork-width").step)
                            new_width = round_to_step(new_width, step)
                            console.log(f"Setting width to: {new_width}")
                            # Format: use int if whole number, float otherwise
                            if abs(new_width - round(new_width)) < 0.001:
                                document.getElementById("artwork-width").value = str(int(round(new_width)))
                            else:
                                document.getElementById("artwork-width").value = str(new_width)
                    except (ValueError, TypeError) as e:
                        console.log(f"Error parsing height: {e}")
                        pass  # Ignore invalid input

        @when("input", "#artwork-width")
        def handle_width_change(event):
            """Handle width input change - update height if locked."""
            update_aspect_ratio_display()
            # Only update orientation if NOT locked (locked orientation is user-controlled via toggle button)
            if not aspect_lock_state["locked"]:
                update_orientation_icon()
            if aspect_lock_state["locked"] and aspect_lock_state["ratio"]:
                width_val = document.getElementById("artwork-width").value
                if not width_val or not str(width_val).strip():
                    # If width is cleared, clear height too
                    console.log("Width cleared, clearing height")
                    document.getElementById("artwork-height").value = ""
                else:
                    try:
                        width = float(width_val)
                        if width > 0:  # Only update for positive values
                            new_height = width * aspect_lock_state["ratio"]
                            # Round to step
                            step = float(document.getElementById("artwork-height").step)
                            new_height = round_to_step(new_height, step)
                            # Format: use int if whole number, float otherwise
                            if abs(new_height - round(new_height)) < 0.001:
                                document.getElementById("artwork-height").value = str(int(round(new_height)))
                            else:
                                document.getElementById("artwork-height").value = str(new_height)
                    except (ValueError, TypeError):
                        pass  # Ignore invalid input

        # ===== Orientation Toggle =====

        def update_orientation_icon():
            """Update the orientation icon based on current dimensions."""
            try:
                height_val = document.getElementById("artwork-height").value
                width_val = document.getElementById("artwork-width").value
                if not height_val or not width_val:
                    return  # Skip update if either field is empty
                height = float(height_val)
                width = float(width_val)
                btn = document.getElementById("orientation-toggle")
                if width > height:
                    btn.className = "orientation-btn landscape"
                else:
                    btn.className = "orientation-btn portrait"
            except (ValueError, TypeError):
                pass  # Ignore invalid input

        @when("click", "#orientation-toggle")
        def handle_orientation_toggle(event):
            """Swap height and width values."""
            height_input = document.getElementById("artwork-height")
            width_input = document.getElementById("artwork-width")
            # Swap values
            old_height = height_input.value
            height_input.value = width_input.value
            width_input.value = old_height

            # If ratio is locked, invert the locked ratio to match new orientation
            if aspect_lock_state["locked"] and aspect_lock_state["ratio"]:
                aspect_lock_state["ratio"] = 1 / aspect_lock_state["ratio"]
                console.log(f"Inverted locked ratio to: {aspect_lock_state['ratio']:.3f}")

            # Update icon
            update_orientation_icon()
            # Update aspect ratio display
            update_aspect_ratio_display()
            # Trigger save and re-render
            save_current_settings()
            try:
                calculate_frame()
                render_visualization()
            except Exception as e:
                console.log(f"Auto-update after orientation swap: {e}")

        # ===== Mat Toggle =====

        @when("change", "#include-mat")
        def handle_mat_toggle(event):
            """Toggle mat inclusion - enable/disable mat width input."""
            include_mat = document.getElementById("include-mat").checked
            mat_input = document.getElementById("mat-width")
            if include_mat:
                mat_input.disabled = False
                # Restore a sensible default if it was 0
                if float(mat_input.value) == 0:
                    mat_input.value = "2.0"
            else:
                mat_input.disabled = True

        # ===== Settings Management (localStorage) =====

        def get_default_settings():
            """Return default settings for all form fields (from defaults.py)."""
            return {
                "artwork_height": str(DEFAULT_ARTWORK_HEIGHT),
                "artwork_width": str(DEFAULT_ARTWORK_WIDTH),
                "include_mat": DEFAULT_INCLUDE_MAT,
                "mat_width": str(DEFAULT_MAT_WIDTH),
                "frame_width": str(DEFAULT_FRAME_MATERIAL_WIDTH),
                "glazing_thickness": str(DEFAULT_GLAZING_THICKNESS),
                "matboard_thickness": str(DEFAULT_MATBOARD_THICKNESS),
                "artwork_thickness": str(DEFAULT_ARTWORK_THICKNESS),
                "backing_thickness": str(DEFAULT_BACKING_THICKNESS),
                "rabbet_depth": str(DEFAULT_RABBET_DEPTH),
                "frame_depth": str(DEFAULT_FRAME_THICKNESS),
                "blade_width": str(DEFAULT_BLADE_WIDTH),
            }

        def save_current_settings():
            """Save all current form field values to localStorage."""
            try:
                settings = {
                    "artwork_height": document.getElementById("artwork-height").value,
                    "artwork_width": document.getElementById("artwork-width").value,
                    "include_mat": document.getElementById("include-mat").checked,
                    "mat_width": document.getElementById("mat-width").value,
                    "frame_width": document.getElementById("frame-width").value,
                    "glazing_thickness": document.getElementById("glazing-thickness").value,
                    "matboard_thickness": document.getElementById("matboard-thickness").value,
                    "artwork_thickness": document.getElementById("artwork-thickness").value,
                    "backing_thickness": document.getElementById("backing-thickness").value,
                    "rabbet_depth": document.getElementById("rabbet-depth").value,
                    "frame_depth": document.getElementById("frame-depth").value,
                    "blade_width": document.getElementById("blade-width").value
                }
                settings_json = json.dumps(settings)
                localStorage.setItem("frame_designer_settings", settings_json)
                console.log(f"üíæ Settings saved to localStorage: {settings_json}")
            except Exception as e:
                console.error(f"Error saving settings: {e}")

        def restore_settings():
            """Restore form field values from localStorage."""
            try:
                settings_json = localStorage.getItem("frame_designer_settings")
                console.log(f"Attempting to restore settings: {settings_json}")
                if settings_json:
                    settings = json.loads(settings_json)
                    console.log(f"Parsed settings: {settings}")
                    document.getElementById("artwork-height").value = settings.get("artwork_height", "10")
                    document.getElementById("artwork-width").value = settings.get("artwork_width", "8")
                    # Restore mat toggle state
                    include_mat = settings.get("include_mat", True)
                    document.getElementById("include-mat").checked = include_mat
                    mat_input = document.getElementById("mat-width")
                    mat_input.value = settings.get("mat_width", "2")
                    mat_input.disabled = not include_mat
                    document.getElementById("frame-width").value = settings.get("frame_width", "1.5")
                    document.getElementById("glazing-thickness").value = settings.get("glazing_thickness", "0.093")
                    document.getElementById("matboard-thickness").value = settings.get("matboard_thickness", "0.055")
                    document.getElementById("artwork-thickness").value = settings.get("artwork_thickness", "0.008")
                    document.getElementById("backing-thickness").value = settings.get("backing_thickness", "0.125")
                    document.getElementById("rabbet-depth").value = settings.get("rabbet_depth", "0.375")
                    document.getElementById("frame-depth").value = settings.get("frame_depth", "0.75")
                    document.getElementById("blade-width").value = settings.get("blade_width", "0.125")
                    console.log("‚úÖ Settings restored from localStorage")
                    return True
                else:
                    console.log("No saved settings found in localStorage")
                return False
            except Exception as e:
                console.error(f"Error restoring settings: {e}")
                return False

        def reset_to_defaults():
            """Reset all form fields to default values."""
            defaults = get_default_settings()
            document.getElementById("artwork-height").value = defaults["artwork_height"]
            document.getElementById("artwork-width").value = defaults["artwork_width"]
            # Reset mat toggle
            document.getElementById("include-mat").checked = defaults["include_mat"]
            mat_input = document.getElementById("mat-width")
            mat_input.value = defaults["mat_width"]
            mat_input.disabled = not defaults["include_mat"]
            document.getElementById("frame-width").value = defaults["frame_width"]
            document.getElementById("glazing-thickness").value = defaults["glazing_thickness"]
            document.getElementById("matboard-thickness").value = defaults["matboard_thickness"]
            document.getElementById("artwork-thickness").value = defaults["artwork_thickness"]
            document.getElementById("backing-thickness").value = defaults["backing_thickness"]
            document.getElementById("rabbet-depth").value = defaults["rabbet_depth"]
            document.getElementById("frame-depth").value = defaults["frame_depth"]
            document.getElementById("blade-width").value = defaults["blade_width"]
            # Clear from localStorage
            localStorage.removeItem("frame_designer_settings")
            console.log("Reset to default settings")

        # Auto-save settings when any form field changes
        def setup_auto_save():
            """Attach change listeners to all form fields to auto-save settings and auto-update visualization."""
            from pyodide.ffi import create_proxy

            def save_and_update_handler(event):
                """Handler that saves settings, updates calculations, and re-renders visualization."""
                save_current_settings()
                # Auto-update calculations (Streamlit-like behavior)
                try:
                    calculate_frame()
                except Exception as e:
                    console.log(f"Auto-calculate skipped: {e}")
                # Auto-update visualization
                try:
                    render_visualization()
                except Exception as e:
                    console.log(f"Auto-render skipped: {e}")

            field_ids = [
                "artwork-height", "artwork-width", "include-mat", "mat-width", "frame-width",
                "glazing-thickness", "matboard-thickness", "artwork-thickness",
                "backing-thickness", "rabbet-depth", "frame-depth", "blade-width"
            ]

            # Create a proxy that persists beyond the function call
            handler_proxy = create_proxy(save_and_update_handler)
            for field_id in field_ids:
                element = document.getElementById(field_id)
                if element:
                    element.addEventListener("change", handler_proxy)
                    console.log(f"Added auto-save and auto-render listener to {field_id}")

        # Event handler: Reset to Defaults button
        @when("click", "#reset-settings")
        def reset_settings_handler(event):
            """Reset all settings to defaults."""
            reset_to_defaults()
            console.log("Settings reset to defaults")
            # Auto-update calculations and visualization with default values
            try:
                calculate_frame()
            except Exception as e:
                console.log(f"Auto-calculate after reset skipped: {e}")
            try:
                render_visualization()
            except Exception as e:
                console.log(f"Auto-render after reset skipped: {e}")

        # ===== Export Functions =====

        def generate_text_summary():
            """Generate a text/markdown summary of the current frame design."""
            current_unit = get_current_unit()

            # Get form values
            height_input = document.getElementById("artwork-height").value
            width_input = document.getElementById("artwork-width").value
            mat_width_input = document.getElementById("mat-width").value
            frame_width_input = document.getElementById("frame-width").value

            height = input_to_inches(height_input, current_unit)
            width = input_to_inches(width_input, current_unit)
            frame_width = input_to_inches(frame_width_input, current_unit)

            # Check mat toggle
            include_mat = document.getElementById("include-mat").checked
            if include_mat:
                mat_width = input_to_inches(mat_width_input, current_unit)
            else:
                mat_width = 0.0

            # Get advanced options
            glazing_thick = input_to_inches(document.getElementById("glazing-thickness").value, current_unit)
            matboard_thick = input_to_inches(document.getElementById("matboard-thickness").value, current_unit)
            artwork_thick = input_to_inches(document.getElementById("artwork-thickness").value, current_unit)
            backing_thick = input_to_inches(document.getElementById("backing-thickness").value, current_unit)
            rabbet_depth = input_to_inches(document.getElementById("rabbet-depth").value, current_unit)
            frame_depth = input_to_inches(document.getElementById("frame-depth").value, current_unit)
            blade_width = input_to_inches(document.getElementById("blade-width").value, current_unit)

            # Create design
            design = FrameDesign(
                artwork_height=height,
                artwork_width=width,
                mat_width_top_bottom=mat_width,
                mat_width_sides=mat_width,
                frame_material_width=frame_width,
                rabbet_depth=rabbet_depth,
                matboard_thickness=matboard_thick,
                glazing_thickness=glazing_thick,
                artwork_thickness=artwork_thick,
                backing_thickness=backing_thick,
                frame_material_depth=frame_depth,
            )

            # Get calculations
            frame_inside = design.get_frame_inside_dimensions()
            frame_outside = design.get_frame_outside_dimensions()
            cut_list = design.get_cut_list()
            required_depth = design.get_rabbet_z_depth_required()
            total_wood_length = design.get_total_wood_length(saw_margin=blade_width)

            # Build summary
            lines = []
            lines.append("=" * 50)
            lines.append("FRAME DESIGN SUMMARY")
            lines.append("=" * 50)
            lines.append("")

            # Artwork
            lines.append("ARTWORK DIMENSIONS")
            lines.append("-" * 30)
            lines.append(f"  Height: {format_value(height, current_unit)}")
            lines.append(f"  Width:  {format_value(width, current_unit)}")
            lines.append("")

            # Cut List
            lines.append("CUT LIST")
            lines.append("-" * 30)
            for category, pieces in cut_list.items():
                category_name = "Top & Bottom" if "horizontal" in category else "Left & Right"
                for piece_spec in pieces:
                    qty = piece_spec.get('quantity', 1)
                    inside = piece_spec.get('inside_length', 0)
                    outside = piece_spec.get('outside_length', 0)
                    lines.append(f"  {category_name}: {qty}x {format_value(outside, current_unit)} (inside: {format_value(inside, current_unit)})")
            lines.append("")

            # Material Requirements
            lines.append("MATERIAL REQUIREMENTS")
            lines.append("-" * 30)
            lines.append(f"  Total Wood Length: {format_value(total_wood_length, current_unit)}")
            lines.append(f"    (includes {format_value(blade_width, current_unit)} blade kerf + 1/16\" error margin per piece)")
            lines.append("")

            # Frame Dimensions
            lines.append("FRAME DIMENSIONS")
            lines.append("-" * 30)
            lines.append(f"  Inside:  {format_value(frame_inside[0], current_unit)} H x {format_value(frame_inside[1], current_unit)} W")
            lines.append(f"  Outside: {format_value(frame_outside[0], current_unit)} H x {format_value(frame_outside[1], current_unit)} W")
            lines.append("")

            # Matboard (if applicable)
            if design.has_mat:
                matboard_dims = design.get_matboard_dimensions()
                mat_opening = design.get_mat_opening_dimensions()
                mat_cut_width = mat_width + rabbet_depth

                lines.append("MATBOARD DETAILS")
                lines.append("-" * 30)
                lines.append(f"  Matboard Size: {format_value(matboard_dims[0], current_unit)} H x {format_value(matboard_dims[1], current_unit)} W")
                lines.append(f"  Mat Opening:   {format_value(mat_opening[0], current_unit)} H x {format_value(mat_opening[1], current_unit)} W")
                lines.append(f"  Visual Mat Width: {format_value(mat_width, current_unit)}")
                lines.append(f"  Mat Border Cut Width: {format_value(mat_cut_width, current_unit)} (visual + {format_value(rabbet_depth, current_unit)} rabbet)")
                lines.append("")

            # Depth Requirements
            lines.append("DEPTH REQUIREMENTS (Z-AXIS)")
            lines.append("-" * 30)
            lines.append(f"  Required Depth: {format_value(required_depth, current_unit)}")
            lines.append(f"  Available Depth: {format_value(frame_depth, current_unit)}")
            if required_depth > frame_depth:
                shortfall = required_depth - frame_depth
                lines.append(f"  *** WARNING: Frame is {format_value(shortfall, current_unit)} too shallow! ***")
            else:
                clearance = frame_depth - required_depth
                lines.append(f"  Clearance: {format_value(clearance, current_unit)}")
            lines.append("")

            # Specifications
            lines.append("SPECIFICATIONS")
            lines.append("-" * 30)
            lines.append(f"  Frame Material Width: {format_value(frame_width, current_unit)}")
            lines.append(f"  Frame Material Depth: {format_value(frame_depth, current_unit)}")
            lines.append(f"  Rabbet Depth (x/y): {format_value(rabbet_depth, current_unit)}")
            lines.append(f"  Mat Overlap: {format_value(design.mat_overlap, current_unit)}")
            lines.append("")
            lines.append("  Material Thicknesses:")
            lines.append(f"    Glazing:  {format_value(glazing_thick, current_unit)}")
            lines.append(f"    Matboard: {format_value(matboard_thick, current_unit)}")
            lines.append(f"    Artwork:  {format_value(artwork_thick, current_unit)}")
            lines.append(f"    Backing:  {format_value(backing_thick, current_unit)}")
            lines.append("")
            lines.append("=" * 50)

            return "\n".join(lines)

        def download_file(content, filename, mime_type):
            """Trigger a file download in the browser."""
            from js import Blob, URL, document as js_document

            # Create blob and download link
            blob = Blob.new([content], {"type": mime_type})
            url = URL.createObjectURL(blob)

            # Create temporary link and click it
            link = js_document.createElement("a")
            link.href = url
            link.download = filename
            link.click()

            # Clean up
            URL.revokeObjectURL(url)

        @when("click", "#export-text")
        def handle_export_text(event):
            """Export frame design as text file."""
            try:
                summary = generate_text_summary()
                download_file(summary, "frame_design_summary.txt", "text/plain")
                status_div = document.getElementById("export-status")
                status_div.innerHTML = '<span class="success">‚úÖ Text summary downloaded!</span>'
            except Exception as e:
                status_div = document.getElementById("export-status")
                status_div.innerHTML = f'<span class="warning">‚ùå Export error: {e}</span>'
                console.log(f"Export error: {e}")

        def generate_pdf_content(pdf, start_y=20):
            """Add formatted content to PDF. Returns final y position."""
            current_unit = get_current_unit()

            # Colors from UI theme (RGB values)
            COLOR_PRIMARY = (39, 125, 161)      # cerulean #277da1
            COLOR_SUCCESS = (144, 190, 109)     # willow-green #90be6d
            COLOR_WARNING = (249, 199, 79)      # tuscan-sun #f9c74f
            COLOR_ERROR = (249, 65, 68)         # strawberry-red #f94144
            COLOR_HIGHLIGHT = (255, 165, 0)     # orange for cut list
            COLOR_BLACK = (0, 0, 0)
            COLOR_GRAY = (100, 100, 100)

            # Get form values
            height_input = document.getElementById("artwork-height").value
            width_input = document.getElementById("artwork-width").value
            mat_width_input = document.getElementById("mat-width").value
            frame_width_input = document.getElementById("frame-width").value

            height = input_to_inches(height_input, current_unit)
            width = input_to_inches(width_input, current_unit)
            frame_width = input_to_inches(frame_width_input, current_unit)

            include_mat = document.getElementById("include-mat").checked
            mat_width = input_to_inches(mat_width_input, current_unit) if include_mat else 0.0

            glazing_thick = input_to_inches(document.getElementById("glazing-thickness").value, current_unit)
            matboard_thick = input_to_inches(document.getElementById("matboard-thickness").value, current_unit)
            artwork_thick = input_to_inches(document.getElementById("artwork-thickness").value, current_unit)
            backing_thick = input_to_inches(document.getElementById("backing-thickness").value, current_unit)
            rabbet_depth = input_to_inches(document.getElementById("rabbet-depth").value, current_unit)
            frame_depth = input_to_inches(document.getElementById("frame-depth").value, current_unit)
            blade_width = input_to_inches(document.getElementById("blade-width").value, current_unit)

            design = FrameDesign(
                artwork_height=height,
                artwork_width=width,
                mat_width_top_bottom=mat_width,
                mat_width_sides=mat_width,
                frame_material_width=frame_width,
                rabbet_depth=rabbet_depth,
                matboard_thickness=matboard_thick,
                glazing_thickness=glazing_thick,
                artwork_thickness=artwork_thick,
                backing_thickness=backing_thick,
                frame_material_depth=frame_depth,
            )

            frame_inside = design.get_frame_inside_dimensions()
            frame_outside = design.get_frame_outside_dimensions()
            cut_list = design.get_cut_list()
            required_depth = design.get_rabbet_z_depth_required()
            total_wood_length = design.get_total_wood_length(saw_margin=blade_width)

            y = start_y
            left_col = 15
            right_col = 110  # Right column starts here

            def add_section(text, x=left_col):
                nonlocal y
                pdf.setFontSize(12)
                pdf.setFont("helvetica", "bold")
                pdf.setTextColor(*COLOR_PRIMARY)
                pdf.text(text, x, y)
                pdf.setTextColor(*COLOR_BLACK)
                y += 6

            def add_line(text, x=left_col, indent=0, color=None):
                nonlocal y
                pdf.setFontSize(11)
                pdf.setFont("helvetica", "normal")
                if color:
                    pdf.setTextColor(*color)
                pdf.text(text, x + indent, y)
                if color:
                    pdf.setTextColor(*COLOR_BLACK)
                y += 5

            def add_spacer(height=3):
                nonlocal y
                y += height

            # Two-column layout for compact display
            col_start_y = y

            # LEFT COLUMN
            # Artwork
            add_section("Artwork")
            add_line(f"{format_value(height, current_unit)} H  x  {format_value(width, current_unit)} W")
            add_spacer()

            # Cut List
            add_section("Cut List")
            for category, pieces in cut_list.items():
                category_name = "Top/Bottom" if "horizontal" in category else "Sides"
                for piece_spec in pieces:
                    qty = piece_spec.get('quantity', 1)
                    outside = piece_spec.get('outside_length', 0)
                    # Format: "Top/Bottom: 17 3/4" (17.75") (√ó2)"
                    # Note: format_value already includes decimal in parens for fractional values
                    formatted_val = format_value(outside, current_unit)
                    pdf.setFontSize(11)
                    pdf.setFont("helvetica", "normal")
                    pdf.text(f"{category_name}: ", left_col, y)
                    x_pos = left_col + pdf.getTextWidth(f"{category_name}: ")
                    pdf.setFont("helvetica", "bold")
                    pdf.setTextColor(*COLOR_HIGHLIGHT)
                    pdf.text(formatted_val, x_pos, y)
                    x_pos += pdf.getTextWidth(formatted_val)
                    pdf.setFont("helvetica", "normal")
                    pdf.setTextColor(*COLOR_GRAY)
                    pdf.text(f" (√ó{qty})", x_pos, y)
                    pdf.setTextColor(*COLOR_BLACK)
                    y += 5
            add_spacer()

            # Material
            add_section("Material")
            pdf.setFontSize(11)
            pdf.setFont("helvetica", "normal")
            pdf.text("Total length: ", left_col, y)
            x_pos = left_col + pdf.getTextWidth("Total length: ")
            pdf.setFont("helvetica", "bold")
            pdf.setTextColor(*COLOR_PRIMARY)
            pdf.text(format_value(total_wood_length, current_unit), x_pos, y)
            pdf.setTextColor(*COLOR_BLACK)
            y += 5
            add_spacer()

            # Frame dims (outside first)
            add_section("Frame")
            add_line(f"Outside: {format_value(frame_outside[0], current_unit)} x {format_value(frame_outside[1], current_unit)}")
            add_line(f"Inside: {format_value(frame_inside[0], current_unit)} x {format_value(frame_inside[1], current_unit)}")

            left_col_end_y = y

            # RIGHT COLUMN
            y = col_start_y

            # Matboard
            if design.has_mat:
                matboard_dims = design.get_matboard_dimensions()
                mat_opening = design.get_mat_opening_dimensions()
                mat_cut_width = mat_width + rabbet_depth

                add_section("Matboard", right_col)
                add_line(f"Size: {format_value(matboard_dims[0], current_unit)} x {format_value(matboard_dims[1], current_unit)}", right_col)
                add_line(f"Opening: {format_value(mat_opening[0], current_unit)} x {format_value(mat_opening[1], current_unit)}", right_col)
                add_line(f"Visual width: {format_value(mat_width, current_unit)}", right_col)
                add_line(f"Cut width: {format_value(mat_cut_width, current_unit)}", right_col)
                add_spacer()

            # Depth
            add_section("Depth (Z)", right_col)
            add_line(f"Required: {format_value(required_depth, current_unit)}", right_col)
            add_line(f"Available: {format_value(frame_depth, current_unit)}", right_col)
            if required_depth > frame_depth:
                shortfall = required_depth - frame_depth
                add_line(f"SHORT BY {format_value(shortfall, current_unit)}!", right_col, 0, COLOR_ERROR)
            else:
                clearance = frame_depth - required_depth
                add_line(f"OK (+{format_value(clearance, current_unit)})", right_col, 0, COLOR_SUCCESS)
            add_spacer()

            # Specs
            add_section("Specs", right_col)
            add_line(f"Frame width: {format_value(frame_width, current_unit)}", right_col)
            add_line(f"Rabbet: {format_value(rabbet_depth, current_unit)}", right_col)
            add_line(f"Mat overlap: {format_value(design.mat_overlap, current_unit)}", right_col)

            return max(y, left_col_end_y)

        @when("click", "#export-pdf")
        def handle_export_pdf(event):
            """Export frame design as PDF with vector diagram at top, details below (single page)."""
            from js import jspdf, window
            from pyodide.ffi import create_proxy

            status_div = document.getElementById("export-status")

            try:
                status_div.innerHTML = '<span style="color: #888;">Generating PDF...</span>'

                # Check if SVG exists
                svg_elem = document.querySelector("#matplotlib-canvas svg")
                if svg_elem:
                    # Get SVG dimensions to calculate aspect ratio
                    bbox = svg_elem.getBoundingClientRect()
                    svg_width = float(bbox.width) or 800
                    svg_height = float(bbox.height) or 600

                    # Calculate diagram dimensions for top portion of page
                    max_diagram_height = 145
                    page_width = 195
                    aspect = svg_height / svg_width
                    img_width = page_width
                    img_height = page_width * aspect

                    if img_height > max_diagram_height:
                        img_height = max_diagram_height
                        img_width = img_height / aspect

                    x_offset = (210 - img_width) / 2

                    # JS creates PDF with vector SVG, returns it to Python for text
                    def on_pdf_created(pdf):
                        try:
                            if pdf:
                                # Add text content below the diagram
                                text_start_y = 5 + img_height + 6
                                generate_pdf_content(pdf, start_y=text_start_y)
                                pdf.save("frame_design_summary.pdf")
                                status_div.innerHTML = '<span class="success">‚úÖ PDF downloaded (vector)!</span>'
                            else:
                                # Fallback to Python-only PDF (no diagram)
                                console.log("JS PDF creation failed, falling back to text-only")
                                fallback_pdf = jspdf.jsPDF.new()
                                generate_pdf_content(fallback_pdf, start_y=20)
                                fallback_pdf.save("frame_design_summary.pdf")
                                status_div.innerHTML = '<span class="success">‚úÖ PDF downloaded (no diagram)</span>'
                        except Exception as e:
                            console.log(f"Error in PDF completion: {e}")
                            import traceback
                            console.log(traceback.format_exc())
                            status_div.innerHTML = f'<span class="warning">‚ùå PDF error: {e}</span>'

                    # Call JS to create PDF with vector SVG
                    promise = window.createPdfWithVectorSvg(x_offset, 5, img_width, img_height)
                    promise.then(create_proxy(on_pdf_created))

                else:
                    # No SVG, just save the text PDF
                    pdf = jspdf.jsPDF.new()
                    generate_pdf_content(pdf, start_y=20)
                    pdf.save("frame_design_summary.pdf")
                    status_div.innerHTML = '<span class="success">‚úÖ PDF downloaded!</span>'

            except Exception as e:
                import traceback
                console.log(f"PDF export error: {e}")
                console.log(traceback.format_exc())
                status_div = document.getElementById("export-status")
                status_div.innerHTML = f'<span class="warning">‚ùå PDF export error: {e}</span>'

        # ===== Named Configurations Management =====

        def get_current_config():
            """Get current form values as a configuration object."""
            return {
                "artwork_height": document.getElementById("artwork-height").value,
                "artwork_width": document.getElementById("artwork-width").value,
                "mat_width": document.getElementById("mat-width").value,
                "frame_width": document.getElementById("frame-width").value,
                "glazing_thickness": document.getElementById("glazing-thickness").value,
                "matboard_thickness": document.getElementById("matboard-thickness").value,
                "artwork_thickness": document.getElementById("artwork-thickness").value,
                "backing_thickness": document.getElementById("backing-thickness").value,
                "rabbet_depth": document.getElementById("rabbet-depth").value,
                "frame_depth": document.getElementById("frame-depth").value,
                "blade_width": document.getElementById("blade-width").value
            }

        def load_saved_configs():
            """Load saved configurations from localStorage."""
            try:
                configs_json = localStorage.getItem("frame_designer_saved_configs")
                if configs_json:
                    return json.loads(configs_json)
                return []
            except Exception as e:
                console.error(f"Error loading saved configs: {e}")
                return []

        def save_config_to_storage(name, config):
            """Save a named configuration to localStorage."""
            try:
                configs = load_saved_configs()
                # Check for duplicate name
                existing = [c for c in configs if c["name"] == name]
                if existing:
                    console.log(f"Configuration '{name}' already exists, updating...")
                    configs = [c for c in configs if c["name"] != name]

                configs.append({"name": name, "config": config})
                localStorage.setItem("frame_designer_saved_configs", json.dumps(configs))
                console.log(f"Saved configuration: {name}")
                return True
            except Exception as e:
                console.error(f"Error saving config: {e}")
                return False

        def delete_config(name):
            """Delete a named configuration from localStorage."""
            try:
                configs = load_saved_configs()
                configs = [c for c in configs if c["name"] != name]
                localStorage.setItem("frame_designer_saved_configs", json.dumps(configs))
                console.log(f"Deleted configuration: {name}")
                render_saved_configs()
            except Exception as e:
                console.error(f"Error deleting config: {e}")

        def load_config(config):
            """Load a configuration into the form fields."""
            try:
                document.getElementById("artwork-height").value = config.get("artwork_height", "10")
                document.getElementById("artwork-width").value = config.get("artwork_width", "8")
                document.getElementById("mat-width").value = config.get("mat_width", "2")
                document.getElementById("frame-width").value = config.get("frame_width", "1.5")
                document.getElementById("glazing-thickness").value = config.get("glazing_thickness", "0.093")
                document.getElementById("matboard-thickness").value = config.get("matboard_thickness", "0.055")
                document.getElementById("artwork-thickness").value = config.get("artwork_thickness", "0.008")
                document.getElementById("backing-thickness").value = config.get("backing_thickness", "0.125")
                document.getElementById("rabbet-depth").value = config.get("rabbet_depth", "0.375")
                document.getElementById("frame-depth").value = config.get("frame_depth", "0.75")
                document.getElementById("blade-width").value = config.get("blade_width", "0.125")
                # Also save to current settings
                save_current_settings()
                # Auto-update visualization with loaded config
                try:
                    render_visualization()
                except Exception as e:
                    console.log(f"Auto-render after config load skipped: {e}")
            except Exception as e:
                console.error(f"Error loading config: {e}")

        def render_saved_configs():
            """Render the list of saved configurations."""
            from pyodide.ffi import create_proxy

            configs = load_saved_configs()
            container = document.getElementById("saved-configs-list")

            if not configs:
                container.innerHTML = '<p style="color: #888; font-style: italic;">No saved configurations yet.</p>'
                return

            html = '<div style="display: grid; gap: 10px;">'
            for config_data in configs:
                name = config_data["name"]
                config = config_data["config"]
                # Create a card for each configuration
                html += f'''
                <div style="background: #2a2d35; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold;">{name}</span>
                    <div style="display: flex; gap: 5px;">
                        <button class="load-config-btn" data-name="{name}" style="background-color: #4a7c8a; padding: 5px 10px; font-size: 12px;">Load</button>
                        <button class="delete-config-btn" data-name="{name}" style="background-color: #8a4a4a; padding: 5px 10px; font-size: 12px;">Delete</button>
                    </div>
                </div>
                '''
            html += '</div>'
            container.innerHTML = html

            # Attach event listeners to buttons using create_proxy for proper callback handling
            def make_load_handler(cfg):
                def handler(e):
                    load_config(cfg)
                return create_proxy(handler)

            def make_delete_handler(config_name):
                def handler(e):
                    delete_config(config_name)
                return create_proxy(handler)

            for btn in document.querySelectorAll(".load-config-btn"):
                config_name = btn.getAttribute("data-name")
                config_data = [c for c in configs if c["name"] == config_name][0]
                btn.addEventListener("click", make_load_handler(config_data["config"]))

            for btn in document.querySelectorAll(".delete-config-btn"):
                config_name = btn.getAttribute("data-name")
                btn.addEventListener("click", make_delete_handler(config_name))

        # Event handler: Save Configuration button
        @when("click", "#save-config")
        def save_config_handler(event):
            """Save the current configuration with a name."""
            try:
                name_input = document.getElementById("config-name")
                name = name_input.value.strip()

                if not name:
                    console.log("Please enter a configuration name")
                    return

                config = get_current_config()
                if save_config_to_storage(name, config):
                    name_input.value = ""  # Clear input
                    render_saved_configs()
                    console.log(f"Configuration '{name}' saved successfully")
            except Exception as e:
                console.error(f"Error in save_config_handler: {e}")

        # Event handler: Add Custom Size button
        @when("click", "#add-custom-size")
        def add_custom_size_handler(event):
            """Add a new custom size to localStorage."""
            try:
                # Get form values
                name_input = document.getElementById("custom-size-name")
                height_input = document.getElementById("custom-size-height")
                width_input = document.getElementById("custom-size-width")
                msg_div = document.getElementById("add-size-message")

                name = name_input.value.strip()
                if not name:
                    msg_div.innerHTML = '<div class="warning">‚ö†Ô∏è Please enter a name for the size</div>'
                    return

                current_unit = get_current_unit()

                # Get values and convert to inches for storage
                height_value = float(height_input.value)
                width_value = float(width_input.value)

                # Convert to inches (storage format)
                if current_unit == "mm":
                    height_inches = mm_to_inches(height_value)
                    width_inches = mm_to_inches(width_value)
                else:
                    height_inches = height_value
                    width_inches = width_value

                # Check for duplicate name (prompt to override)
                existing_size_index = None
                for idx, size in enumerate(app_state["custom_sizes"]):
                    if size.name.lower() == name.lower():
                        existing_size_index = idx
                        break

                if existing_size_index is not None:
                    # Ask user if they want to override
                    if not confirm(f'A size named "{name}" already exists. Do you want to override it with the new dimensions?'):
                        msg_div.innerHTML = f'<div class="warning">‚ö†Ô∏è Cancelled - size "{name}" was not modified.</div>'
                        return
                    # Remove the old one (will be replaced below)
                    app_state["custom_sizes"].pop(existing_size_index)

                # Check for duplicate dimensions (warning but allow)
                duplicate_dims = None
                for size in app_state["custom_sizes"]:
                    if abs(size.height - height_inches) < 0.01 and abs(size.width - width_inches) < 0.01:
                        duplicate_dims = size.name
                        break

                # Add new size
                new_size = FrameSize(name=name, height=height_inches, width=width_inches)
                app_state["custom_sizes"].append(new_size)

                # Save to localStorage
                save_custom_sizes()

                # Re-render the list
                render_custom_sizes()

                # Show success message (with warning if duplicate dimensions or override)
                if existing_size_index is not None:
                    msg_div.innerHTML = f'<div class="success">‚úÖ Updated: {name} (overridden with new dimensions)</div>'
                elif duplicate_dims:
                    msg_div.innerHTML = f'<div class="warning">‚úÖ Saved: {name}<br>‚ö†Ô∏è Note: These dimensions match existing size "{duplicate_dims}"</div>'
                else:
                    msg_div.innerHTML = f'<div class="success">‚úÖ Saved: {name}</div>'

                # Clear form
                name_input.value = ""
                height_input.value = "18.0"
                width_input.value = "24.0"

                console.log(f"Added custom size: {name}")

                # Clear message after 3 seconds
                import asyncio
                async def clear_message():
                    await asyncio.sleep(3)
                    msg_div.innerHTML = ""
                asyncio.create_task(clear_message())

            except ValueError:
                msg_div = document.getElementById("add-size-message")
                msg_div.innerHTML = '<div class="warning">‚ö†Ô∏è Please enter valid numbers for dimensions</div>'
            except Exception as e:
                msg_div = document.getElementById("add-size-message")
                msg_div.innerHTML = f'<div class="warning">‚ùå Error: {e}</div>'
                console.log(f"Error adding custom size: {e}")

        # Calculate frame dimensions - can be called directly or via button click
        def calculate_frame(event=None):
            """Calculate frame dimensions using existing FrameDesign class."""
            try:
                # Get current unit
                current_unit = get_current_unit()

                # Get form values and convert to inches for calculations
                height_input = document.getElementById("artwork-height").value
                width_input = document.getElementById("artwork-width").value
                mat_width_input = document.getElementById("mat-width").value
                frame_width_input = document.getElementById("frame-width").value

                # Skip calculation if required fields are empty
                if not height_input or not width_input or not frame_width_input or not mat_width_input:
                    console.log("Skipping calculation - required fields empty")
                    return

                height = input_to_inches(height_input, current_unit)
                width = input_to_inches(width_input, current_unit)
                frame_width = input_to_inches(frame_width_input, current_unit)

                # Check mat toggle - use 0 if mat is excluded
                include_mat = document.getElementById("include-mat").checked
                if include_mat:
                    mat_width = input_to_inches(mat_width_input, current_unit)
                else:
                    mat_width = 0.0

                # Create design using EXISTING code (calculations in inches!)
                # Get advanced options
                glazing_value = float(document.getElementById("glazing-thickness").value)
                matboard_t_value = float(document.getElementById("matboard-thickness").value)
                artwork_t_value = float(document.getElementById("artwork-thickness").value)
                backing_value = float(document.getElementById("backing-thickness").value)
                rabbet_value = float(document.getElementById("rabbet-depth").value)
                frame_depth_value = float(document.getElementById("frame-depth").value)
                blade_width_value = float(document.getElementById("blade-width").value)

                # Convert to inches if needed
                glazing_thick = input_to_inches(str(glazing_value), current_unit)
                matboard_thick = input_to_inches(str(matboard_t_value), current_unit)
                artwork_thick = input_to_inches(str(artwork_t_value), current_unit)
                backing_thick = input_to_inches(str(backing_value), current_unit)
                rabbet_depth = input_to_inches(str(rabbet_value), current_unit)
                frame_depth = input_to_inches(str(frame_depth_value), current_unit)
                blade_width = input_to_inches(str(blade_width_value), current_unit)

                design = FrameDesign(
                    artwork_height=height,
                    artwork_width=width,
                    mat_width_top_bottom=mat_width,
                    mat_width_sides=mat_width,
                    frame_material_width=frame_width,
                    rabbet_depth=rabbet_depth,
                    matboard_thickness=matboard_thick,
                    glazing_thickness=glazing_thick,
                    artwork_thickness=artwork_thick,
                    backing_thickness=backing_thick,
                    frame_material_depth=frame_depth,
                )

                # Get calculations using EXISTING methods
                frame_inside = design.get_frame_inside_dimensions()
                frame_outside = design.get_frame_outside_dimensions()
                cut_list = design.get_cut_list()
                required_depth = design.get_rabbet_z_depth_required()
                total_wood_length = design.get_total_wood_length(saw_margin=blade_width)

                # Matboard dimensions (if using mat)
                matboard_dims = design.get_matboard_dimensions() if design.has_mat else None
                mat_opening = design.get_mat_opening_dimensions() if design.has_mat else None

                # Format results using selected unit
                results_html = ''

                # === Artwork Dimensions ===
                results_html += '<strong>üìê Artwork Dimensions:</strong>'
                results_html += f'<ul style="margin: 4px 0 12px 0; padding-left: 20px;"><li>{format_value(height, current_unit)} H √ó {format_value(width, current_unit)} W</li></ul>'

                # === Cut List ===
                results_html += '<strong>ü™ö Cut List:</strong>'
                results_html += '<ul style="margin: 4px 0 12px 0; padding-left: 20px;">'
                for category, pieces in cut_list.items():
                    category_name = "Top & Bottom" if "horizontal" in category else "Left & Right"
                    for piece_spec in pieces:
                        qty = piece_spec.get('quantity', 1)
                        inside = piece_spec.get('inside_length', 0)
                        outside = piece_spec.get('outside_length', 0)
                        results_html += f'<li>{category_name}: {qty}√ó '
                        results_html += f'<strong style="color: #ffa500;">{format_value(outside, current_unit)}</strong> '
                        results_html += f'<span style="color: #888;">(inside edge: {format_value(inside, current_unit)})</span></li>'
                results_html += '</ul>'

                # === Total Wood Length ===
                results_html += '<strong>üì¶ Material Requirements:</strong>'
                results_html += '<ul style="margin: 4px 0 12px 0; padding-left: 20px;">'
                results_html += f'<li>Total Wood Length: <strong style="color: #3b9cff;">{format_value(total_wood_length, current_unit)}</strong>'
                results_html += f'<br><small style="color: #888;">Includes saw blade kerf ({format_value(blade_width, current_unit)}) and error margin (1/16") per piece</small></li>'
                results_html += '</ul>'

                # === Frame Dimensions ===
                results_html += '<strong>üñºÔ∏è Frame Dimensions:</strong>'
                results_html += '<ul style="margin: 4px 0 12px 0; padding-left: 20px;">'
                results_html += f'<li>Inside: {format_value(frame_inside[0], current_unit)} H √ó {format_value(frame_inside[1], current_unit)} W</li>'
                results_html += f'<li>Outside: {format_value(frame_outside[0], current_unit)} H √ó {format_value(frame_outside[1], current_unit)} W</li>'
                results_html += '</ul>'

                # === Matboard Dimensions (if applicable) ===
                if design.has_mat and matboard_dims and mat_opening:
                    mat_cut_width = mat_width + rabbet_depth
                    results_html += '<strong>üé® Matboard Details:</strong>'
                    results_html += '<ul style="margin: 4px 0 12px 0; padding-left: 20px;">'
                    results_html += f'<li>Matboard Size: {format_value(matboard_dims[0], current_unit)} H √ó {format_value(matboard_dims[1], current_unit)} W</li>'
                    results_html += f'<li>Mat Opening: {format_value(mat_opening[0], current_unit)} H √ó {format_value(mat_opening[1], current_unit)} W</li>'
                    results_html += f'<li>Visual Mat Width: {format_value(mat_width, current_unit)}</li>'
                    results_html += f'<li>Mat Border Cut Width: {format_value(mat_cut_width, current_unit)} <small style="color: #888;">(visual + {format_value(rabbet_depth, current_unit)} rabbet)</small></li>'
                    results_html += '</ul>'

                # === Depth Requirements with Warning ===
                results_html += '<strong>üìè Depth Requirements (Z-axis):</strong>'
                results_html += '<ul style="margin: 4px 0 12px 0; padding-left: 20px;">'
                results_html += f'<li>Required: {format_value(required_depth, current_unit)}'
                results_html += '<br><small style="color: #888;">(glazing + matboard + artwork + backing + assembly margin)</small></li>'
                results_html += f'<li>Available: {format_value(frame_depth, current_unit)}</li>'
                # Depth warning/success
                if required_depth > frame_depth:
                    shortfall = required_depth - frame_depth
                    results_html += f'<li><span style="color: var(--rf-error-red); font-weight: bold;">‚ö†Ô∏è WARNING: Frame is {format_value(shortfall, current_unit)} too shallow!</span>'
                    results_html += '<br><small style="color: var(--rf-error-red);">Materials will not fit in the rabbet. Use deeper frame stock.</small></li>'
                else:
                    clearance = frame_depth - required_depth
                    results_html += f'<li><span style="color: var(--rf-success-green);">‚úÖ Adequate depth ({format_value(clearance, current_unit)} clearance)</span></li>'
                results_html += '</ul>'

                # Display results
                results_div = document.getElementById("results")
                results_div.innerHTML = results_html

            except Exception as e:
                results_div = document.getElementById("results")
                results_div.innerHTML = f'<span class="warning">‚ùå Error: {e}</span>'

        # Button click handler for manual calculate (if button exists)
        @when("click", "#calculate")
        def calculate_frame_click(event):
            """Manual calculate button handler."""
            calculate_frame()

        # Event handler: Test localStorage
        @when("click", "#test-storage")
        def test_local_storage(event):
            """Demonstrate NATIVE localStorage access (no workarounds!)."""
            try:
                # Save custom size to localStorage
                custom_sizes = [
                    {"name": "Test Canvas", "height": 12.5, "width": 18.75},
                    {"name": "Test Print", "height": 8.0, "width": 10.0}
                ]

                # Save to localStorage (DIRECT ACCESS!)
                localStorage.setItem(
                    "frame_designer_custom_sizes",
                    json.dumps(custom_sizes)
                )

                # Load back from localStorage
                loaded_data = localStorage.getItem("frame_designer_custom_sizes")
                loaded_sizes = json.loads(loaded_data)

                results_html = f"""
                <div class="success">‚úÖ localStorage Test Successful!</div>
                <br>
                <strong>Saved Data:</strong><br>
                {json.dumps(custom_sizes, indent=2)}<br>
                <br>
                <strong>Loaded Data:</strong><br>
                {json.dumps(loaded_sizes, indent=2)}<br>
                <br>
                <span class="success">‚≠ê NO WORKAROUNDS NEEDED - Native browser API!</span>
                """

                results_div = document.getElementById("results")
                results_div.innerHTML = f'<pre>{results_html}</pre>'

            except Exception as e:
                results_div = document.getElementById("results")
                results_div.innerHTML = f'<span class="warning">‚ùå Error: {e}</span>'

        # Helper function: Render visualization from current form values
        def render_visualization():
            """Render the frame visualization with dimension annotations and transparency overlaps."""
            try:
                import matplotlib.pyplot as plt
                import matplotlib.patches as mpatches
                from pyscript import display as pyscript_display

                # Get current unit
                current_unit = get_current_unit()

                # Get form values and convert to inches
                height_input = document.getElementById("artwork-height").value
                width_input = document.getElementById("artwork-width").value
                mat_width_input = document.getElementById("mat-width").value
                frame_width_input = document.getElementById("frame-width").value

                artwork_height = input_to_inches(height_input, current_unit)
                artwork_width = input_to_inches(width_input, current_unit)
                frame_width = input_to_inches(frame_width_input, current_unit)

                # Check mat toggle - use 0 if mat is excluded
                include_mat = document.getElementById("include-mat").checked
                if include_mat:
                    mat_width = input_to_inches(mat_width_input, current_unit)
                else:
                    mat_width = 0.0

                # Get advanced options
                glazing_value = float(document.getElementById("glazing-thickness").value)
                matboard_t_value = float(document.getElementById("matboard-thickness").value)
                artwork_t_value = float(document.getElementById("artwork-thickness").value)
                backing_value = float(document.getElementById("backing-thickness").value)
                rabbet_value = float(document.getElementById("rabbet-depth").value)
                frame_depth_value = float(document.getElementById("frame-depth").value)

                # Convert to inches if needed
                glazing_thick = input_to_inches(str(glazing_value), current_unit)
                matboard_thick = input_to_inches(str(matboard_t_value), current_unit)
                artwork_thick = input_to_inches(str(artwork_t_value), current_unit)
                backing_thick = input_to_inches(str(backing_value), current_unit)
                rabbet_depth = input_to_inches(str(rabbet_value), current_unit)
                frame_depth = input_to_inches(str(frame_depth_value), current_unit)

                # Create design using form values (in inches)
                design = FrameDesign(
                    artwork_height=artwork_height,
                    artwork_width=artwork_width,
                    mat_width_top_bottom=mat_width,
                    mat_width_sides=mat_width,
                    frame_material_width=frame_width,
                    rabbet_depth=rabbet_depth,
                    matboard_thickness=matboard_thick,
                    glazing_thickness=glazing_thick,
                    artwork_thickness=artwork_thick,
                    backing_thickness=backing_thick,
                    frame_material_depth=frame_depth,
                )

                # ==== 1. Get all dimensions ====
                frame_outer_h, frame_outer_w = design.get_frame_outside_dimensions()
                inside_h, inside_w = design.get_frame_inside_dimensions()
                matboard_h, matboard_w = design.get_matboard_dimensions()
                mat_inner_h, mat_inner_w = design.get_mat_opening_dimensions()
                mat_outer_h, mat_outer_w = design.get_visible_dimensions()

                # Debug: log dimensions to verify proportions
                console.log(f"=== Visualization Debug ===")
                console.log(f"Artwork: {artwork_height} x {artwork_width}")
                console.log(f"Frame width (input): {frame_width}")
                console.log(f"Mat width: {mat_width}")
                console.log(f"Frame outer: {frame_outer_h} x {frame_outer_w}")
                console.log(f"Visible/inside: {inside_h} x {inside_w}")
                console.log(f"Expected frame_outer = inside + 2*frame_width: {inside_h + 2*frame_width} x {inside_w + 2*frame_width}")
                console.log(f"Ratio frame_width/frame_outer_w: {frame_width/frame_outer_w:.4f} (should show as this fraction of total width)")

                # ==== 2. Create figure ====
                # For SVG output, figsize determines aspect ratio; DPI is ignored
                figsize = (6, 6)
                fig, ax = plt.subplots(figsize=figsize)

                # ==== 3. Draw Frame (outermost rectangle) ====
                frame_x, frame_y = 0, 0
                ax.add_patch(mpatches.Rectangle(
                    (frame_x, frame_y),
                    frame_outer_w,
                    frame_outer_h,
                    facecolor='#8B6F47',
                    edgecolor=None,
                    linewidth=2,
                    label='Frame'
                ))

                # ==== 4. Draw Matboard/Artwork (content inside frame) ====
                #
                # VISUALIZATION GEOMETRY (important for correct proportions):
                # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                # The frame_width measurement INCLUDES the rabbet depth. For example:
                #   - frame_width = 1" (total frame material width)
                #   - rabbet_depth = 0.375" (the lip that overlaps content)
                #   - visible frame face = 0.625" (the part you see from the front)
                #
                # Key positions (from frame outer edge):
                #   - frame outer edge: 0
                #   - content_x/y: frame_width - rabbet (where content starts, UNDER frame lip)
                #   - visible_x/y: frame_width (the visible opening - where you see through)
                #
                # The content (matboard/artwork) is drawn starting at content_x/y, extending
                # UNDER the frame's rabbet lip. The rabbet overlay shows the frame covering
                # the content edges - this overlay is WITHIN the frame_width area, not beyond it.
                #
                # This ensures the visual frame width exactly matches the specified frame_width,
                # with the rabbet shown as a semi-transparent overlap within that width.
                #
                rabbet = design.rabbet_depth
                visible_x = frame_x + frame_width
                visible_y = frame_y + frame_width
                content_x = visible_x - rabbet  # Content starts under the frame lip
                content_y = visible_y - rabbet

                if mat_width > 0:
                    # Matboard extends under the frame's rabbet lip
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, content_y),
                        mat_outer_w + 2 * rabbet,  # Extended to go under frame on both sides
                        mat_outer_h + 2 * rabbet,
                        facecolor='#FEFEFE',
                        edgecolor=None,
                        linewidth=1,
                        label='Matboard'
                    ))

                    # === Frame-Matboard overlap (rabbet) - show frame lip over matboard ===
                    # Draw semi-transparent overlay from content edge to visible opening
                    # This is WITHIN the frame_width area, not extending beyond it
                    overlap_alpha = 0.7

                    # Bottom rabbet overlap (frame lip covering bottom edge of matboard)
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, content_y),
                        mat_outer_w + 2 * rabbet,
                        rabbet,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))
                    # Top rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, visible_y + mat_outer_h),
                        mat_outer_w + 2 * rabbet,
                        rabbet,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))
                    # Left rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, content_y + rabbet),
                        rabbet,
                        mat_outer_h,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))
                    # Right rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (visible_x + mat_outer_w, content_y + rabbet),
                        rabbet,
                        mat_outer_h,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))

                    # === Matboard window (white opening) ===
                    mat_window_x = visible_x + mat_width
                    mat_window_y = visible_y + mat_width
                    ax.add_patch(mpatches.Rectangle(
                        (mat_window_x, mat_window_y),
                        mat_inner_w,
                        mat_inner_h,
                        facecolor='white',
                        edgecolor='#DDDDDD',
                        linewidth=0.75
                    ))

                    # === Artwork (sits under mat window) ===
                    art_x = mat_window_x - design.mat_overlap
                    art_y = mat_window_y - design.mat_overlap
                    ax.add_patch(mpatches.Rectangle(
                        (art_x, art_y),
                        artwork_width,
                        artwork_height,
                        facecolor='#5B9BD5',
                        edgecolor=None,
                        linewidth=1,
                        label='Artwork'
                    ))

                    # === Mat-Artwork overlap - TRANSPARENCY ===
                    if design.mat_overlap > 0:
                        # Top overlap
                        ax.add_patch(mpatches.Rectangle(
                            (art_x, art_y),
                            artwork_width,
                            design.mat_overlap,
                            facecolor='#FEFEFE',
                            edgecolor=None,
                            alpha=0.8
                        ))
                        # Bottom overlap
                        ax.add_patch(mpatches.Rectangle(
                            (art_x, art_y + artwork_height - design.mat_overlap),
                            artwork_width,
                            design.mat_overlap,
                            facecolor='#FEFEFE',
                            edgecolor=None,
                            alpha=0.8
                        ))
                        # Left overlap
                        ax.add_patch(mpatches.Rectangle(
                            (art_x, art_y + design.mat_overlap),
                            design.mat_overlap,
                            artwork_height - 2 * design.mat_overlap,
                            facecolor='#FEFEFE',
                            edgecolor=None,
                            alpha=0.8
                        ))
                        # Right overlap
                        ax.add_patch(mpatches.Rectangle(
                            (art_x + artwork_width - design.mat_overlap, art_y + design.mat_overlap),
                            design.mat_overlap,
                            artwork_height - 2 * design.mat_overlap,
                            facecolor='#FEFEFE',
                            edgecolor=None,
                            alpha=0.8
                        ))
                else:
                    # No mat - draw artwork directly inside frame
                    # Artwork extends under the frame's rabbet lip
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, content_y),
                        artwork_width + 2 * rabbet,  # Extended to go under frame on both sides
                        artwork_height + 2 * rabbet,
                        facecolor='#5B9BD5',
                        edgecolor=None,
                        linewidth=1,
                        label='Artwork'
                    ))

                    # === Frame-Artwork overlap (rabbet) - show frame lip over artwork ===
                    overlap_alpha = 0.7

                    # Bottom rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, content_y),
                        artwork_width + 2 * rabbet,
                        rabbet,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))
                    # Top rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, visible_y + artwork_height),
                        artwork_width + 2 * rabbet,
                        rabbet,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))
                    # Left rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (content_x, content_y + rabbet),
                        rabbet,
                        artwork_height,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))
                    # Right rabbet overlap
                    ax.add_patch(mpatches.Rectangle(
                        (visible_x + artwork_width, content_y + rabbet),
                        rabbet,
                        artwork_height,
                        facecolor='#8B6F47',
                        edgecolor=None,
                        alpha=overlap_alpha
                    ))

                # ==== 5. Set axes limits with margin ====
                # Responsive margin calculation based on figure size (matching Streamlit approach)
                fig_width_inches = figsize[0]
                if fig_width_inches <= 6:
                    margin_factor = 0.15  # Larger margins for small figures
                elif fig_width_inches <= 8:
                    margin_factor = 0.12
                else:
                    margin_factor = 0.10

                margin = max(frame_outer_w, frame_outer_h) * margin_factor

                # Center the frame by making margins equal on all sides
                ax.set_xlim(-margin, frame_outer_w + margin)
                ax.set_ylim(-margin, frame_outer_h + margin)
                ax.set_aspect('equal')

                # ==== 6. Add dimension annotations (blueprint style) ====
                # Font sizing based on figure size (not data dimensions) for consistency
                # This keeps text size constant regardless of frame thickness
                base_font_size = min(figsize[0], figsize[1])  # figsize is (6, 6)
                font_size = max(8, int(base_font_size * 1.1))

                # Define shared y-positions for consolidated labels at fixed distances from frame
                # This ensures consistent spacing regardless of frame dimensions
                top_label_y = frame_outer_h + margin * 0.35  # Shared y for Outside and Frame
                bottom_label_y = frame_y - margin * 0.35      # Shared y for Inside and Mat

                # Prepare label texts
                outside_text = f"Outside: {format_value(frame_outer_h, current_unit, 2)} √ó {format_value(frame_outer_w, current_unit, 2)}"
                frame_width_text = f"Frame: {format_value(frame_width, current_unit, 2)}"

                # Estimate label widths (rough approximation: 0.6 * font_size per character in data units)
                # We'll use a proportion of frame width as spacing
                char_width_approx = frame_outer_w * 0.012  # Approximate character width in data units
                outside_label_width = len(outside_text) * char_width_approx
                frame_label_width = len(frame_width_text) * char_width_approx
                label_gap = frame_outer_w * 0.08  # Gap between the two labels (increased to prevent overlap)

                # Calculate total width and center position for the label pair
                total_label_width = outside_label_width + label_gap + frame_label_width
                pair_center_x = frame_outer_w / 2

                # Position Outside label aligned to left edge of frame
                outside_label_half_width = len(outside_text) * char_width_approx / 2
                outside_x = outside_label_half_width + margin * 0.1  # Left-aligned with small margin

                # Horizontal offset from label center (configurable)
                ARROW_HORIZONTAL_OFFSET_FACTOR = 0.08  # Adjust this value to change arrow horizontal offset
                horizontal_offset = frame_outer_w * ARROW_HORIZONTAL_OFFSET_FACTOR

                # Outside label - arrow points to top edge of frame, slightly RIGHT of label center
                outside_arrow_x = max(0, min(frame_outer_w, outside_x + horizontal_offset))
                ax.annotate(
                    outside_text,
                    xy=(outside_arrow_x, frame_outer_h),  # Arrow tip AT frame top edge
                    xytext=(outside_x, top_label_y),  # Label position
                    arrowprops=dict(arrowstyle='->', lw=0.7, color='black'),
                    ha='center', va='center',
                    fontsize=font_size,
                    bbox=dict(boxstyle='round,pad=0.25', fc='#FFF3E0', ec='gray', alpha=0.85)
                )

                # Frame width annotation (top section)
                # Drafting-style dimension with arrows and callout
                # Position dimension line at consistent height relative to frame top
                frame_bracket_y = frame_outer_h + margin * 0.05  # Just above frame top edge

                # Draw dimension line with bidirectional arrow: |<--  -->|
                # Frame width measured from inner edge (visible opening) to outer edge
                #
                # TICK ALIGNMENT CALCULATION:
                # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                # Matplotlib draws lines CENTERED on the specified coordinate.
                # To align a tick's EDGE with a boundary, offset by half the line width.
                #
                # Formula: tick_line_width = (lw_points / 72) * (data_range / figure_inches)
                #   - lw_points: line width in points (1 point = 1/72 inch)
                #   - data_range: total data units across the figure
                #   - figure_inches: physical figure width in inches
                #
                # For frame width tick (measuring from visible opening to outer edge):
                #   - LEFT tick: align LEFT edge with visible opening ‚Üí offset by -tick_line_width/2
                #   - RIGHT tick: at frame outer edge (no offset needed, extends outward)
                #
                # For mat width tick (measuring from content edge to mat window):
                #   - BOTTOM tick: align TOP edge with content edge ‚Üí offset by -tick_line_width/2
                #   - TOP tick: align BOTTOM edge with mat window ‚Üí offset by +tick_line_width/2
                #
                tick_lw_points = 0.8
                data_width = frame_outer_w + 2 * margin
                physical_width = 6  # figsize width in inches
                tick_line_width = (tick_lw_points / 72) * (data_width / physical_width)
                # Position tick so its LEFT edge aligns with the visible opening
                # (line is centered on coordinate, so offset by half line width)
                frame_dim_left = visible_x + mat_outer_w - tick_line_width / 2  # Inner edge of frame
                frame_dim_right = frame_outer_w  # Outer edge of frame
                frame_dim_center = (frame_dim_left + frame_dim_right) / 2

                # Single continuous bidirectional arrow spanning full distance
                ax.annotate(
                    '',
                    xy=(frame_dim_right, frame_bracket_y),  # Right endpoint
                    xytext=(frame_dim_left, frame_bracket_y),  # Left endpoint
                    arrowprops=dict(arrowstyle='<->,head_length=0.3,head_width=0.15', lw=0.6, color='#D2691E', shrinkA=0, shrinkB=0, mutation_scale=5)
                )

                # Perpendicular tick marks at ends (asymmetric - shorter on top to make room for label)
                ax.plot([frame_dim_left, frame_dim_left], [frame_bracket_y - font_size * 0.15, frame_bracket_y + font_size * 0.05],
                       color='#D2691E', lw=0.8, linestyle='--', dashes=[3, 2], alpha=0.8)
                ax.plot([frame_dim_right, frame_dim_right], [frame_bracket_y - font_size * 0.15, frame_bracket_y + font_size * 0.05],
                       color='#D2691E', lw=0.8, linestyle='--', dashes=[3, 2], alpha=0.8)

                # Label positioning algorithm with priority order:
                # 1. Try to center on dimension line
                # 2. If that extends past right tick, align right edge with right tick
                # 3. If either would overlap Outside label, shift right to avoid overlap

                # Estimate label widths in data coordinates (inches)
                # Use character count as fraction of frame width (works for any size)
                char_width_fraction = 0.005  # Each character is roughly 0.5% of frame width
                frame_label_half_width = len(frame_width_text) * char_width_fraction * frame_outer_w
                outside_label_half_width = len(outside_text) * char_width_fraction * frame_outer_w
                gap = 0.15  # minimum gap between labels in inches

                # Step 1: Try centered position
                centered_x = (frame_dim_left + frame_dim_right) / 2

                # Step 2: Check if right edge would extend past right tick
                # Add a safety margin (10% of label width) to account for bbox padding
                safety_margin = frame_label_half_width * 0.1
                if centered_x + frame_label_half_width > frame_dim_right - safety_margin:
                    # Shift left to align right edge with right tick (with margin)
                    candidate_x = frame_dim_right - frame_label_half_width - safety_margin
                else:
                    candidate_x = centered_x

                # Step 3: Check if left edge would overlap with Outside label
                outside_right_edge = outside_x + outside_label_half_width
                left_edge_of_frame_label = candidate_x - frame_label_half_width
                if left_edge_of_frame_label < outside_right_edge + gap:
                    # Shift right to avoid overlap (may extend past right tick)
                    frame_label_x = outside_right_edge + gap + frame_label_half_width
                else:
                    frame_label_x = candidate_x

                # Final constraint: ensure right edge stays within frame boundary
                max_allowed_x = frame_outer_w - frame_label_half_width - safety_margin
                if frame_label_x > max_allowed_x:
                    frame_label_x = max_allowed_x

                ax.text(
                    frame_label_x,
                    top_label_y,  # Same Y as Outside label
                    frame_width_text,
                    ha='center', va='center',
                    fontsize=font_size - 1,
                    bbox=dict(boxstyle='round,pad=0.2', fc='#FFF3E0', ec='#D2691E', alpha=0.9, linewidth=1.5)
                )

                # Inside dimension (bottom, shifted right to make room for rabbet callout)
                inside_text = f"Inside: {format_value(inside_h, current_unit, 2)} √ó {format_value(inside_w, current_unit, 2)}"
                if mat_width > 0:
                    # Mat cut width = visible width + rabbet (part hidden under frame)
                    mat_cut_width = mat_width + rabbet
                    mat_width_text = f"Mat: {format_value(mat_cut_width, current_unit, 2)} ({format_value(mat_width, current_unit, 2)} visible)"
                else:
                    mat_width_text = "Mat: None"

                # Rabbet depth callout (bottom left, tick-style like frame width)
                # Use teal color (#009688) to distinguish from frame (orange) and mat (gray)
                rabbet_color = '#009688'
                rabbet_text = f"Rabbet: {format_value(rabbet, current_unit, 2)}"
                rabbet_bracket_y = frame_y - margin * 0.05  # Just below frame bottom edge

                # Rabbet dimension from content edge to visible opening
                rabbet_dim_left = content_x - tick_line_width / 2  # Left edge (content starts here)
                rabbet_dim_right = visible_x + tick_line_width / 2  # Right edge (visible opening)

                # Single bidirectional arrow (smaller head for narrow dimension)
                ax.annotate(
                    '',
                    xy=(rabbet_dim_right, rabbet_bracket_y),
                    xytext=(rabbet_dim_left, rabbet_bracket_y),
                    arrowprops=dict(arrowstyle='<->,head_length=0.3,head_width=0.15', lw=0.6, color=rabbet_color,
                                   shrinkA=0, shrinkB=0, mutation_scale=5)
                )

                # Perpendicular tick marks at ends (shorter for compact appearance)
                tick_height = font_size * 0.10
                ax.plot([rabbet_dim_left, rabbet_dim_left], [rabbet_bracket_y - tick_height * 0.3, rabbet_bracket_y + tick_height],
                       color=rabbet_color, lw=0.6, linestyle='--', dashes=[2, 1.5], alpha=0.8)
                ax.plot([rabbet_dim_right, rabbet_dim_right], [rabbet_bracket_y - tick_height * 0.3, rabbet_bracket_y + tick_height],
                       color=rabbet_color, lw=0.6, linestyle='--', dashes=[2, 1.5], alpha=0.8)

                # Estimate label widths
                inside_label_width = len(inside_text) * char_width_approx
                mat_label_width = len(mat_width_text) * char_width_approx
                rabbet_label_width = len(rabbet_text) * char_width_approx
                rabbet_label_half_width = rabbet_label_width / 2

                # Position Rabbet label aligned to left edge
                rabbet_label_x = rabbet_label_half_width + margin * 0.1

                ax.text(
                    rabbet_label_x,
                    bottom_label_y,  # Same Y as other bottom labels
                    rabbet_text,
                    ha='center', va='center',
                    fontsize=font_size - 1,
                    bbox=dict(boxstyle='round,pad=0.2', fc='#E0F2F1', ec=rabbet_color, alpha=0.9, linewidth=1.5)
                )

                # Position Inside label to the right of Rabbet label
                inside_label_half_width = len(inside_text) * char_width_approx / 2
                inside_x = rabbet_label_x + rabbet_label_half_width + label_gap + inside_label_half_width

                # Inside label - arrow points to visible opening edge (at visible_y)
                inside_edge_y = visible_y  # The visible opening is at frame_width from the edge
                inside_arrow_x = max(0, min(frame_outer_w, inside_x + horizontal_offset))  # Arrow points RIGHT
                ax.annotate(
                    inside_text,
                    xy=(inside_arrow_x, inside_edge_y),  # Arrow tip AT visible opening edge
                    xytext=(inside_x, bottom_label_y),  # Label position
                    arrowprops=dict(arrowstyle='->', lw=0.7, color='black'),
                    ha='center', va='center',
                    fontsize=font_size,
                    bbox=dict(boxstyle='round,pad=0.25', fc='#E3F2FD', ec='gray', alpha=0.85)
                )

                # Mat width annotation (on right side, opposite from Inside label)
                if mat_width > 0:
                    # Drafting-style dimension with arrows and callout (vertical)
                    # Position dimension line on the RIGHT side of the mat
                    mat_bracket_x = visible_x + mat_outer_w - mat_cut_width * 0.3  # Position bracket partway into mat from right

                    # Draw vertical dimension line with bidirectional arrow
                    # Measure full mat cut width (from content edge under rabbet to mat window)
                    # Position tick so its TOP edge aligns with content edge (under rabbet)
                    mat_dim_bottom = content_y - tick_line_width / 2  # Outer edge (under frame rabbet)
                    # Position tick so its BOTTOM edge aligns with mat window opening
                    mat_dim_top = visible_y + mat_width + tick_line_width / 2  # Inner edge (mat window)
                    mat_dim_center = (mat_dim_bottom + mat_dim_top) / 2

                    # Single continuous bidirectional arrow spanning full distance (vertical)
                    ax.annotate(
                        '',
                        xy=(mat_bracket_x, mat_dim_top),  # Top endpoint
                        xytext=(mat_bracket_x, mat_dim_bottom),  # Bottom endpoint
                        arrowprops=dict(arrowstyle='<->,head_length=0.3,head_width=0.15', lw=0.6, color='#666666', shrinkA=0, shrinkB=0, mutation_scale=5)
                    )

                    # Perpendicular tick marks at ends (horizontal for vertical dimension)
                    ax.plot([mat_bracket_x - font_size * 0.15, mat_bracket_x + font_size * 0.15], [mat_dim_bottom, mat_dim_bottom],
                           color='#666666', lw=0.8, linestyle='--', dashes=[3, 2], alpha=0.8)
                    ax.plot([mat_bracket_x - font_size * 0.15, mat_bracket_x + font_size * 0.15], [mat_dim_top, mat_dim_top],
                           color='#666666', lw=0.8, linestyle='--', dashes=[3, 2], alpha=0.8)

                    # Label positioned to the left of dimension line with gap (no callout line)
                    ax.text(
                        mat_bracket_x - mat_cut_width * 0.4,  # To the left of dimension line
                        mat_dim_center,  # Centered vertically on dimension line
                        mat_width_text,
                        ha='right', va='center',
                        fontsize=font_size - 1,
                        bbox=dict(boxstyle='round,pad=0.2', fc='#F1F8E9', ec='#666666', alpha=0.9, linewidth=1.5)
                    )

                # Matboard dimension (on top mat band)
                if mat_width > 0:
                    mat_center_y = (visible_y + mat_outer_h) - (mat_width / 2)
                    matboard_text = f"Matboard: {format_value(matboard_h, current_unit, 2)} √ó {format_value(matboard_w, current_unit, 2)}"
                    ax.text(
                        visible_x + mat_outer_w / 2,
                        mat_center_y,
                        matboard_text,
                        ha='center', va='center',
                        fontsize=font_size,
                        bbox=dict(boxstyle='round,pad=0.2', fc='#F1F8E9', alpha=0.85)
                    )

                # Center annotations - Artwork & Mat opening
                center_x = frame_outer_w / 2
                center_y = frame_outer_h / 2
                line_gap = 0.06 * frame_outer_h

                # Artwork size
                artwork_text = f"Artwork: {format_value(artwork_height, current_unit, 2)} √ó {format_value(artwork_width, current_unit, 2)}"
                ax.text(
                    center_x,
                    center_y + (line_gap / 2),
                    artwork_text,
                    ha='center', va='center',
                    fontsize=font_size,
                    bbox=dict(boxstyle='round,pad=0.2', fc='white', alpha=0.85)
                )

                # Mat opening
                if mat_width > 0:
                    mat_open_text = f"Mat opening: {format_value(mat_inner_h, current_unit, 2)} √ó {format_value(mat_inner_w, current_unit, 2)}"
                    ax.text(
                        center_x,
                        center_y - (line_gap / 2),
                        mat_open_text,
                        ha='center', va='center',
                        fontsize=font_size,
                        bbox=dict(boxstyle='round,pad=0.2', fc='white', alpha=0.85)
                    )

                # ==== 7. Add legend (unique entries) ====
                handles, labels = ax.get_legend_handles_labels()
                unique_labels = []
                unique_handles = []
                for handle, label in zip(handles, labels):
                    if label not in unique_labels:
                        unique_labels.append(label)
                        # Create legend handle with black outline
                        legend_handle = mpatches.Patch(
                            facecolor=handle.get_facecolor(),
                            edgecolor='black',
                            linewidth=0.5
                        )
                        unique_handles.append(legend_handle)

                ax.legend(
                    unique_handles,
                    unique_labels,
                    loc='lower center',
                    bbox_to_anchor=(0.5, -0.02),  # Even closer to plot
                    ncol=len(unique_labels),
                    fontsize=8,
                    columnspacing=1.0,
                    handlelength=1.5
                )

                # ==== 8. Final touches ====
                ax.axis('off')  # Remove title - diagram speaks for itself

                # Tight layout with space for legend at bottom
                # rect=[left, bottom, right, top] in figure coordinates (0-1)
                # Leave 8% space at bottom for legend
                plt.tight_layout(pad=0.1, rect=[0, 0.08, 1, 1])

                # Render to SVG for crisp vector output (perfect zoom quality)
                from io import BytesIO
                svg_buffer = BytesIO()
                fig.savefig(svg_buffer, format='svg', bbox_inches='tight', transparent=True)
                svg_buffer.seek(0)
                svg_content = svg_buffer.read().decode('utf-8')

                # Clean up figure (use clf instead of close to avoid PyScript canvas issues)
                plt.clf()

                # Insert SVG directly into DOM (CSS handles responsive sizing via !important)
                canvas_div = document.getElementById("matplotlib-canvas")
                canvas_div.innerHTML = svg_content

            except Exception as e:
                import traceback
                error_details = traceback.format_exc()
                results_div = document.getElementById("results")
                results_div.innerHTML = f'<span class="warning">‚ùå matplotlib error: {e}<br><br><pre style="font-size:10px">{error_details}</pre><br>Note: matplotlib may take 30-60s to load on first run.</span>'

        # Event handler: Draw visualization button
        @when("click", "#draw-viz")
        def draw_visualization(event):
            """Event handler for Draw Visualization button."""
            render_visualization()

        # Initialize auto-save and restore settings
        setup_auto_save()
        restore_settings()
        render_saved_configs()
        update_aspect_ratio_display()
        update_orientation_icon()

        # Auto-calculate and render on page load
        try:
            calculate_frame()
        except Exception as e:
            console.log(f"Initial calculate skipped: {e}")
        try:
            render_visualization()
        except Exception as e:
            console.log(f"Initial render skipped: {e}")

        # Mark app as ready
        app_status = document.getElementById("app-status")
        app_status.textContent = "‚úì"
        app_status.className = "app-status ready"
        app_status.title = "Application ready"

        # Hide the ready checkmark after 2 seconds
        import asyncio
        async def hide_ready_status():
            await asyncio.sleep(2)
            app_status.style.opacity = "0"
            app_status.style.transition = "opacity 0.5s ease"
            await asyncio.sleep(0.5)  # Wait for fade out
            app_status.style.display = "none"

        asyncio.create_task(hide_ready_status())

        console.log("‚úÖ PyScript initialized successfully!")
        console.log("üñºÔ∏è ReferenceFrame core logic loaded with ZERO changes!")
    </py-script>

    <!-- Service Worker Registration (disabled for development - uncomment for production)
    <script>
        // Register service worker for caching PyScript and matplotlib
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully:', registration.scope);

                        // Show cache status on first load
                        if (!navigator.serviceWorker.controller) {
                            console.log('üì¶ First visit - caching resources for faster future loads...');
                        } else {
                            console.log('‚ö° Serving from cache - fast load!');
                        }

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîÑ New Service Worker update found');

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('‚ú® New version available! Refresh to update.');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    -->
</body>
</html>
