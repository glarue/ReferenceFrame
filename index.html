<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReferenceFrame</title>

    <!-- Preload critical Pyodide assets for faster startup -->
    <!-- These start downloading immediately, before PyScript requests them -->
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.asm.wasm" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.asm.js" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/python_stdlib.zip" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide-lock.json" as="fetch" crossorigin="anonymous">

    <!-- PWA manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#277da1">

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.2/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.6.2/core.js"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- svg2pdf.js for vector SVG embedding (try jsdelivr) -->
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.3/dist/svg2pdf.umd.min.js"></script>
    <!-- QRCode.js for generating QR codes (browser build with global QRCode) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <!-- Application JavaScript -->
    <script src="./app.js"></script>

    <!-- Application Styles -->
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <h1 style="display: flex; align-items: center; gap: 12px;">
        <span class="logo"></span>
        ReferenceFrame
        <span id="app-status" class="app-status loading" title="Loading application..."></span>
    </h1>

    <div class="section">
        <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <span>üìê Frame Calculator</span>
            <!-- Compact Unit Toggle -->
            <div class="unit-toggle">
                <button type="button" id="unit-inches" class="unit-btn active">in</button><span style="color: #666;">|</span><button type="button" id="unit-mm" class="unit-btn">mm</button>
            </div>
        </h2>

        <div class="calculator-grid">
            <!-- Left Column: Inputs -->
            <div class="calculator-inputs">
        <div class="form-group">
            <label>Artwork <span id="label-artwork-unit">(inches)</span>:</label>
            <div class="dimension-pair">
                <span class="dim-label">H</span>
                <input type="number" id="artwork-height" value="12.5" step="0.25" min="1">
                <span class="separator">√ó</span>
                <span class="dim-label">W</span>
                <input type="number" id="artwork-width" value="18.75" step="0.25" min="1">
                <button type="button" id="orientation-toggle" class="orientation-btn landscape" title="Toggle portrait/landscape">
                    <span class="orientation-icon landscape-outline"></span>
                    <span class="orientation-icon portrait-outline"></span>
                </button>
                <span id="aspect-ratio" class="aspect-ratio">3:2</span>
                <button type="button" id="aspect-lock" class="aspect-lock-btn unlocked" title="Lock aspect ratio"><svg viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg></button>
            </div>
        </div>
        <div class="form-group" style="margin-bottom: 15px;">
            <label>
                <input type="checkbox" id="include-mat" checked style="width: auto; margin-right: 6px; vertical-align: middle;">
                Mat / Frame Width <span id="label-mat-frame-unit">(inches)</span>:
            </label>
            <div class="dimension-pair">
                <span class="dim-label">Mat</span>
                <input type="number" id="mat-width" value="2.0" step="0.125" min="0.125">
                <span class="dim-label">Frame</span>
                <input type="number" id="frame-width" value="0.75" step="0.125" min="0.5">
            </div>
        </div>

        <!-- Advanced Material Thickness Options -->
        <details style="margin-top: 15px; padding: 10px; background: #1a1d24; border-radius: 4px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">
                ‚öôÔ∏è Advanced Options
            </summary>
            <div class="options-grid" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="glazing-thickness">Glazing <span id="label-glazing-unit">(in)</span></label>
                    <input type="number" id="glazing-thickness" value="0.093" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="matboard-thickness">Matboard <span id="label-matboard-unit">(in)</span></label>
                    <input type="number" id="matboard-thickness" value="0.055" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="artwork-thickness">Artwork <span id="label-artwork-thickness-unit">(in)</span></label>
                    <input type="number" id="artwork-thickness" value="0.008" step="0.001" min="0">
                </div>
                <div class="form-group">
                    <label for="backing-thickness">Backing <span id="label-backing-unit">(in)</span></label>
                    <input type="number" id="backing-thickness" value="0.125" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="rabbet-depth">Rabbet Depth <span id="label-rabbet-unit">(in)</span></label>
                    <input type="number" id="rabbet-depth" value="0.375" step="0.125" min="0">
                </div>
                <div class="form-group">
                    <label for="frame-depth">Frame Depth <span id="label-frame-depth-unit">(in)</span></label>
                    <input type="number" id="frame-depth" value="0.75" step="0.125" min="0.25">
                </div>
                <div class="form-group">
                    <label for="blade-width">Blade Width <span id="label-blade-unit">(in)</span></label>
                    <input type="number" id="blade-width" value="0.125" step="0.03125" min="0">
                </div>
            </div>
        </details>

        <!-- Saved Configurations Section -->
        <details style="margin-top: 15px; padding: 10px; background: #1a1d24; border-radius: 4px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">
                üíæ Saved Configurations
            </summary>
            <div style="margin-top: 15px;">
                <div class="form-group">
                    <label for="config-name">Configuration Name:</label>
                    <input type="text" id="config-name" placeholder="e.g., Standard Print, Large Canvas">
                </div>
                <button id="save-config" style="background-color: #2a7d2e;">Save Current Configuration</button>
                <div id="saved-configs-list" style="margin-top: 15px;">
                    <!-- Saved configurations will be rendered here -->
                </div>

                <!-- Backup & Restore -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #3a3d45;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #b0b0b0;">Backup & Restore</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="export-all-data" style="flex: 1; min-width: 140px; background-color: #1976d2;">
                            üì• Export All Data
                        </button>
                        <label for="import-data-file" style="flex: 1; min-width: 140px;">
                            <input type="file" id="import-data-file" accept=".json" style="display: none;">
                            <button type="button" style="width: 100%; background-color: #2a7d2e;"
                                    onclick="document.getElementById('import-data-file').click();">
                                üì§ Import Data
                            </button>
                        </label>
                    </div>
                    <div id="import-status" style="margin-top: 8px; font-size: 13px;"></div>
                    <p style="margin: 8px 0 0 0; font-size: 12px; color: #888;">
                        Backs up all saved configurations, custom sizes, and settings
                    </p>
                </div>
            </div>
        </details>

        <button id="reset-settings" style="background-color: #666;">Reset to Defaults</button>
        <!-- Manual trigger buttons hidden since auto-update handles this -->
        <button id="calculate" style="display: none;">Calculate Frame</button>
        <button id="draw-viz" style="display: none;">Draw Visualization</button>
            </div>

            <!-- Right Column: Results Only -->
            <div class="calculator-results">
                <div id="results" style="margin-top: 0;"></div>
            </div>
        </div>

        <!-- Full-width Visualization Section -->
        <div id="canvas-container" style="margin-top: 30px;">
            <div id="matplotlib-canvas"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìê Artwork Size Selector</h2>
        <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 15px;">
            Choose from standard photo sizes or your saved custom sizes.
        </p>

        <!-- Segmented Toggle -->
        <div class="segmented-toggle">
            <button type="button" id="size-tab-standard" class="active">Standard</button>
            <button type="button" id="size-tab-custom">Custom</button>
        </div>

        <!-- Standard Sizes Panel -->
        <div id="standard-sizes-panel" class="size-selector-container">
            <select id="standard-sizes-select">
                <option value="">-- Select a size --</option>
            </select>
            <button id="apply-standard-size" style="width: 100%;">Apply Size</button>
        </div>

        <!-- Custom Sizes Panel (hidden by default) -->
        <div id="custom-sizes-panel" class="size-selector-container" style="display: none;">
            <select id="saved-sizes-select">
                <option value="">-- No saved sizes yet --</option>
            </select>
            <div style="display: flex; gap: 8px;">
                <button id="apply-saved-size" style="flex: 1;">Apply</button>
                <button id="delete-saved-size" style="padding: 10px 16px; background: #dc3545;">Delete</button>
            </div>

            <!-- Inline Custom Size Creation -->
            <div class="custom-size-inline">
                <input type="number" id="custom-size-height" value="18" step="0.25" min="1" placeholder="H" title="Height">
                <span class="dim-separator">√ó</span>
                <input type="number" id="custom-size-width" value="24" step="0.25" min="1" placeholder="W" title="Width">
                <span id="label-custom-height-unit" style="display: none;">(inches)</span>
                <span id="label-custom-width-unit" style="display: none;">(inches)</span>
                <input type="text" id="custom-size-name" placeholder="Name (e.g., Canvas 18√ó24)">
                <button id="add-custom-size" title="Save custom size">+</button>
            </div>
            <div id="add-size-message" style="margin-top: 8px; font-size: 13px;"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìÑ Export</h2>
        <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 15px;">
            Download a printable summary with all dimensions and specifications.
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="export-text">Download Text Summary</button>
            <button id="export-pdf">Download PDF with Diagram</button>
        </div>
        <div id="export-status" style="margin-top: 10px;"></div>
    </div>

    <!-- PyScript Configuration -->
    <py-config type="json">
        {
            "packages": ["matplotlib"],
            "files": {
                "./src/frame.py": "./frame.py",
                "./src/conversions.py": "./conversions.py",
                "./src/defaults.py": "./defaults.py",
                "./src/ui_helpers.py": "./ui_helpers.py",
                "./src/aspect_ratio.py": "./aspect_ratio.py",
                "./src/main.py": "./main.py"
            }
        }
    </py-config>

    <!-- Main PyScript Code -->
    <py-script src="./src/main.py"></py-script>

    <!-- Service Worker Registration for caching -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('New version available - refresh to update');
                                }
                            });
                        });
                    })
                    .catch(error => console.log('SW registration failed:', error));
            });
        }
    </script>
</body>
</html>
